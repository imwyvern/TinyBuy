var app=app||{};app.ItemView=Backbone.View.extend({className:"item",template:_.template($("#item-template").html()),events:{"click .item-image":"select","click .select-shadow":"unselect","click .single-item-info":"showDetail"},render:function(){this.$el.html(this.template(this.model.toJSON()));this.$el.attr("id","item-"+this.model.get("Cookbook").id);return this},select:function(){this.$el.find(".select-shadow").css("display","block");if($(".shopping-cart").css("display")==="none"){$(".shopping-cart").css("display","block")}app.shoppingCart.get("items").add(this.model);app.shoppingCart.get("items").date=this.model.get("date")},unselect:function(){this.$el.find(".select-shadow").css("display","none");app.shoppingCart.get("items").remove(this.model);if(app.shoppingCart.get("items").length==0&&app.shoppingCart.get("tuans").length==0){$(".shopping-cart").css("display","none")}},imgLazyLoad:function(){var e=this.$el.find(".item-image > img");var t=e.attr("lazy-src");var a=this.model.get("Cookbook").priority;if(t!==undefined){var i=new Image;i.onload=function(){e.attr("src",t);e.css({width:"100%",height:"110px","margin-top":"0"});if(a=="1"||a=="2"){e.css("height","180px")}};i.src=t}},showDetail:function(){var e=this;$.ajax({url:$("base").attr("src")+"items/"+this.model.get("Cookbook").id+".json",success:function(t){var a=new app.Item(t.rt_obj.data);$(".container").css("display","none");var i=new app.ItemDetailView({model:a,parent:e})},error:function(e){console.log(e)}})}});app.ItemViewWithoutImg=Backbone.View.extend({className:"item",template:_.template($("#item-template-no-img").html()),events:{"click .item-image":"select","click .select-shadow-no-img":"unselect","click .single-item-info":"showDetail"},render:function(){this.$el.html(this.template(this.model.toJSON()));this.$el.attr("id","item-"+this.model.get("Cookbook").id);this.imgLazyLoad();return this},select:function(){this.$el.find(".select-shadow-no-img").css("display","block");if($(".shopping-cart").css("display")==="none"){$(".shopping-cart").css("display","block")}app.shoppingCart.get("items").add(this.model)},unselect:function(){this.$el.find(".select-shadow-no-img").css("display","none");app.shoppingCart.get("items").remove(this.model);if(app.shoppingCart.get("items").length==0){$(".shopping-cart").css("display","none")}},imgLazyLoad:function(){var e=this.$el.find(".item-image > img");var t=e.attr("lazy-src");var a=this.model.get("Cookbook").priority;if(t!==undefined){var i=new Image;i.onload=function(){e.attr("src",t);e.css({width:"100%",height:"110px","margin-top":"0"});if(a=="1"||a=="2"){e.css("height","180px")}};i.src=t}},showDetail:function(){var e=this;$.ajax({url:$("base").attr("src")+"items/"+this.model.get("Cookbook").id+".json",success:function(t){var a=new app.Item(t.rt_obj.data);$(".container").css("display","none");var i=new app.ItemDetailView({model:a,parent:e})},error:function(e){console.log(e)}})}});app.TuanView=Backbone.View.extend({className:"tuan",template:_.template($("#tuan-template").html()),events:{"click .tuan-image":"select","click .select-shadow":"unselect","click .single-tuan-info":"showDetail"},render:function(){this.$el.html(this.template(this.model.toJSON()));this.$el.attr("id","tuan-"+this.model.get("Tutetuan").id);this.imgLazyLoad();return this},select:function(){this.$el.find(".select-shadow").css("display","block");if($(".shopping-cart").css("display")==="none"){$(".shopping-cart").css("display","block")}app.shoppingCart.get("tuans").add(this.model)},unselect:function(){this.$el.find(".select-shadow").css("display","none");app.shoppingCart.get("tuans").remove(this.model);if(app.shoppingCart.get("items").length==0&&app.shoppingCart.get("tuans").length==0){$(".shopping-cart").css("display","none")}},imgLazyLoad:function(){var e=this.$el.find(".tuan-image > img");var t=e.attr("lazy-src");if(t!==undefined){var a=new Image;a.onload=function(){e.attr("src",t);e.css({width:"100%",height:"180px","margin-top":"0"})};a.src=t}},showDetail:function(){var e=this;$.ajax({url:$("base").attr("src")+"tuans/"+this.model.get("Tutetuan").id+".json",success:function(t){var a=new app.Tuan(t.rt_obj.data);$(".container").css("display","none");var i=new app.TuanDetailView({model:a,parent:e})},error:function(e){console.log(e)}})}});app.TuanViewWithoutImg=Backbone.View.extend({className:"tuan",template:_.template($("#tuan-template-no-img").html()),events:{"click .tuan-image":"select","click .select-shadow-no-img":"unselect","click .single-tuan-info":"showDetail"},render:function(){this.$el.html(this.template(this.model.toJSON()));this.$el.attr("id","tuan-"+this.model.get("Tutetuan").id);this.imgLazyLoad();return this},select:function(){this.$el.find(".select-shadow-no-img").css("display","block");if($(".shopping-cart").css("display")==="none"){$(".shopping-cart").css("display","block")}app.shoppingCart.get("tuans").add(this.model)},unselect:function(){this.$el.find(".select-shadow-no-img").css("display","none");app.shoppingCart.get("tuans").remove(this.model);if(app.shoppingCart.get("tuans").length==0){$(".shopping-cart").css("display","none")}},imgLazyLoad:function(){var e=this.$el.find(".tuan-image > img");var t=e.attr("lazy-src");if(t!==undefined){var a=new Image;a.onload=function(){e.attr("src",t);e.css({width:"100%",height:"180px","margin-top":"0"})};a.src=t}},showDetail:function(){var e=this;$.ajax({url:$("base").attr("src")+"tuans/"+this.model.get("Tutetuan").id+".json",success:function(t){console.log(t);var a=new app.Tuan(t.rt_obj.data);$(".container").css("display","none");var i=new app.TuanDetailView({model:a,parent:e})},error:function(e){console.log(e)}})}});app.LoginView=Backbone.View.extend({className:"container",id:"login-container",template:_.template($("#loginView-template").html()),events:{"click #login":"login","click #forget":"getPassword","click #signin":"signIn","click .back":"back"},initialize:function(e){if(e&&e.backTo){this.backTo=e.backTo}$(".main-container").append(this.render().el)},render:function(){this.$el.html(this.template());return this},login:function(){var that=this;$(".login-tips").hide();$.ajax({url:$("base").attr("src")+"home/login/"+that.getUuid(),method:"post",data:{username:$("input[name=account]").val(),password:$("input[name=password]").val()},success:function(data){var rt_obj=eval("("+data+")");if(rt_obj.code==0){setCookie("wechat_id",current_user,100);that.$el.remove();$("#"+that.backTo).show()}else if(rt_obj.code==2){if(that.$el.find(".warning").length>0){}else{that.$el.find(".login-header").after('<p class="warning">^_^用户名或密码错误，请重新输入</p>')}}},error:function(e){console.log("login failed")}})},getPassword:function(){this.$el.hide();var e=new app.ForgetView;$(".main-container").append(e.render().el)},signIn:function(){},back:function(){var e=this;e.$el.remove();$("#"+e.backTo).show()},getUuid:function(){return function(){var e=window.location.search;var t=e.substr(1,e.length).split("&");for(var a=0;a<t.length;a++){var i=t[a].split("=");if(i[0]=="code"){return unescape(i[1])}}}()}});app.RegisterView=Backbone.View.extend({className:"container",id:"register-container",template:_.template($("#registerView-template").html()),events:{"click #register":"register","click .back":"back"},initialize:function(e){if(e&&e.backTo){this.backTo=e.backTo}$(".main-container").append(this.render().el)},render:function(){this.$el.html(this.template());return this},register:function(){var that=this;if(that.inputValidate()){console.log("validate success");$.ajax({url:$("base").attr("src")+"home/register/"+that.getUuid(),type:"post",data:{username:that.$el.find("input[name=account]").val(),password:that.$el.find("input[name=password]").val(),email:that.$el.find("input[name=email]").val()},success:function(data){var data=eval("("+data+")");if(data.code==0){var popupView=new app.OrderInfoPopupView({msg:"注册成功, 3秒后自动登录"});that.$el.append(popupView.render().el);setTimeout(function(){that.$el.remove();user_status="CUSTOMER";setCookie("wechat_id",current_user,100);$("#"+that.backTo).show()},3e3)}else if(data.code==1){var popupView=new app.OrderInfoPopupView({msg:data.msg});that.$el.append(popupView.render().el)}else if(data.code==2){var popupView=new app.OrderInfoPopupView({msg:data.msg});that.$el.append(popupView.render().el)}},error:function(){console.log("ajax error")}})}},back:function(){var e=this;e.$el.remove();$("#"+e.backTo).show()},inputValidate:function(){var e=this;var t=e.$el.find("input[name=account]").val(),a=e.$el.find("input[name=password]").val(),i=e.$el.find("input[name=repassword]").val(),n=e.$el.find("input[name=email]").val();var s=/^(\w){6,20}$/,r=/^(\w)+(\.\w+)*@(\w)+((\.\w+)+)$/;if(t==""){var o=new app.OrderInfoPopupView({msg:"用户名不能为空"});e.$el.append(o.render().el);return false}else if(!s.exec(a)){var o=new app.OrderInfoPopupView({msg:"密码长度不符合要求（6-20位）"});e.$el.append(o.render().el);return false}else if(a!==i){var o=new app.OrderInfoPopupView({msg:"两次输入的密码不一致"});e.$el.append(o.render().el);return false}else if(!r.exec(n)){var o=new app.OrderInfoPopupView({msg:"邮箱地址不正确"});e.$el.append(o.render().el);return false}else if(s.exec(a)&&r.exec(n)&&a===i){return true}return false},getUuid:function(){return function(){var e=window.location.search;var t=e.substr(1,e.length).split("&");for(var a=0;a<t.length;a++){var i=t[a].split("=");if(i[0]=="code"){return unescape(i[1])}}}()}});app.ForgetView=Backbone.View.extend({className:"container",id:"forget-container",template:_.template($("#forgetPasswordView-template").html()),events:{"click #getPassword":"submit","click .back":"back"},initialize:function(){$(".main-container").append(this.render().el)},render:function(){this.$el.html(this.template());return this},submit:function(){var that=this;$.ajax({url:$("base").attr("src")+"home/forget/"+that.getUuid(),method:"post",data:{username:$("#forget-container input[name=account]").val(),email:$("#forget-container input[name=email]").val()},success:function(data){var dataObj=eval("("+data+")");var popupView=new app.OrderInfoPopupView({msg:dataObj.message});that.$el.append(popupView.render().el)},error:function(e){console.log(e);console.log("login failed")}})},back:function(){this.$el.remove();$("#login-container").show()},getUuid:function(){return function(){var e=window.location.search;var t=e.substr(1,e.length).split("&");for(var a=0;a<t.length;a++){var i=t[a].split("=");if(i[0]=="code"){return unescape(i[1])}}}()}});app.ItemDetailView=Backbone.View.extend({className:"container",id:"itemsdetail-container",template:_.template($("#itemDetailView-template").html()),events:{"click .back":"back","click .addItem":"add"},initialize:function(e){this.parent=e.parent;$(window).scrollTop(0);$(".main-container").append(this.render().el);sc.dropdown("itemsdetail-container",".user");this.$el.append(new app.ShoppingCartView({model:app.shoppingCart}).render().el);if(app.shoppingCart.get("count")>0){if(this.$el.find(".shopping-cart").css("display")==="none"){this.$el.find(".shopping-cart").css("display","block")}}},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},add:function(){if(app.shoppingCart.get("items").get(this.model.get("Material").id)){var e=new app.OrderInfoPopupView({msg:"已加入购物车，请前往购物车查看"});this.$el.append(e.render().el)}else{this.parent.select()}},back:function(){this.$el.remove();$("#menu-container").css("display","block")}});app.TuanDetailView=Backbone.View.extend({className:"container",id:"tuansdetail-container",template:_.template($("#tuanDetailView-template").html()),events:{"click .back":"back","click .addItem":"add"},initialize:function(e){this.parent=e.parent;$(window).scrollTop(0);this.model.set("date",t(this.model));$(".main-container").append(this.render().el);sc.dropdown("tuansdetail-container",".user");this.$el.append(new app.ShoppingCartView({model:app.shoppingCart}).render().el);if(app.shoppingCart.count>0){if(this.$el.find(".shopping-cart").css("display")==="none"){this.$el.find(".shopping-cart").css("display","block")}}function t(e){var t;var a=["零","一","二","三","四","五","六","日"];t=new Date(parseInt(e.get("Tutetuan").time)*1e3);var i=t.getMonth()+1,n=t.getDate(),s=t.getDay();return i+"月"+n+"日周"+a[s]}},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},add:function(){if(app.shoppingCart.get("tuans").get(this.model.get("Tutetuan").id)){}else{this.parent.select()}},back:function(){this.$el.css("display","none");$("#menu-container").css("display","block")}});app.ItemListView=Backbone.View.extend({className:"items",hasPic:false,viewCollection:null,initialize:function(e){this.count=0;this.hasPic=e.hasPic;this.viewCollection=new Array;$(".main").append(this.render().el);this.scrollToLoad()},render:function(){var e=this;var t=this.model.length;var a=this.model.models;for(var i=0;i<t;i++){if(e.hasPic){var n=new app.ItemView({model:a[i]});var s=$(n.render().el);if(a[i].get("Cookbook").priority=="1"||a[i].get("Cookbook").priority=="2"){s.addClass("large");s.find(".select-shadow").addClass("large")}e.viewCollection.push(n)}else{var n=new app.ItemViewWithoutImg({model:a[i]});var s=$(n.render().el);if(a[i].get("Cookbook").priority=="1"||a[i].get("Cookbook").priority=="2"){s.addClass("large");s.find(".select-shadow-no-img").addClass("large")}e.viewCollection.push(n)}e.$el.append(s)}return this},scrollToLoad:function(){var e=this;var t=$(window).height(),a=$("#menu-container").find(".header").height();marqueeHeight=$("#menu-container").find(".marquee").height();footerHeight=$("#menu-container").find(".toolbar").height();listInViewHeight=t-a-footerHeight;var i=0,n=0;var s=marqueeHeight;for(var r=0;r<this.viewCollection.length;r++){if(this.viewCollection[r].$el.hasClass("large")){i+=1}else{break}}while(true){if(i>0){s+=246+20;i--;n++}else{s+=200+20;n+=2}if(s>listInViewHeight){break}}for(var r=0;r<n;r++){this.viewCollection[r].imgLazyLoad()}$(window).scroll(function(){for(var t=n;t<e.viewCollection.length;t++){var a=e.viewCollection[t].$el.height();var i=1;if(a==200){i=2}if($(window).scrollTop()+listInViewHeight>=e.viewCollection[t].$el.offset().top+51){if(i==1){e.viewCollection[t].imgLazyLoad();n++}else if(i==2){e.viewCollection[t++].imgLazyLoad();n++;if(e.viewCollection[t]){e.viewCollection[t].imgLazyLoad();n++}}}}})}});app.TuanListView=Backbone.View.extend({className:"tuans",hasPic:false,initialize:function(e){this.count=0;this.hasPic=e.hasPic;$(".main").append(this.render().el)},render:function(){var e=this;var t=this.model.length;var a=this.model.models;var i=0;for(var n=0;n<t;n++){if(e.hasPic){var s=new app.TuanView({model:a[n]});var r=$(s.render().el);r.addClass("large");r.find(".select-shadow").addClass("large");e.$el.append(r)}else{var s=new app.TuanViewWithoutImg({model:a[n]});var r=$(s.render().el);r.addClass("large");r.find(".select-shadow-no-img").addClass("large");e.$el.append(r)}}return this}});app.ShoppingCartView=Backbone.View.extend({template:_.template($("#shoppingCart-template").html()),events:{click:"enterShoppingCart"},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},enterShoppingCart:function(){$(".container").css("display","none");var e=$("#order-container");if(e.length>0){e.remove();var e=new app.OrderView({model:this.model})}else{var e=new app.OrderView({model:this.model})}}});var app=app||{};app.MenuView=Backbone.View.extend({className:"container",id:"menu-container",template:_.template($("#menuView-template").html()),events:{"click #vegetable":"showVegetables","click #meat":"showMeat","click #soup":"showSoup","click #speciality":"showSpeciality"},hasPic:false,initialize:function(){$(".main-container").append(this.render().el);sc.dropdown("menu-container",".user");sc.togglePic(".togglePic")},render:function(){this.$el.html(this.template("this.model.toJSON()"));return this},setPic:function(e){this.hasPic=e},renderList:function(e){var t=items[e];if(t){var a=new app.ItemCollection;var i;for(var n=0;n<t.length;n++){if(e!=3){var s=new app.Item(t[n]);s.set("date",p(s,e));a.add(s)}else{var r=new app.Tuan(t[n]);r.set("date",p(r,e));a.add(r)}i="items-"+e}if(e==0||e==1||e==2){var o=new app.ItemListView({model:a,id:i,hasPic:this.hasPic})}else if(e==3){var l=new app.TuanListView({model:a,id:i,hasPic:this.hasPic})}}else{return}function p(e,t){var a;var i=["零","一","二","三","四","五","六","日"];if(t=="0"||t=="1"||t=="2"){a=new Date;var n=new Date(a.getTime()+864e5);var s=n.getMonth()+1,r=n.getDate(),o=n.getDay();return s+"月"+r+"日"}else if(t=="3"){a=new Date(parseInt(e.get("Tutetuan").time)*1e3);var s=a.getMonth()+1,r=a.getDate(),o=a.getDay();return s+"月"+r+"日"}}},handleJSON:function(e,t){if(e===undefined){var a=new app.ItemCollection;var i=new app.ItemListView({model:a});return}var n=new app.ItemCollection;var s;for(var r=0;r<e.length;r++){if(t=="0"){var o=new app.Item(e[r]);o.set("date",c(o,"0"));app.vegetableCollection.add(o);s="items-0";n=app.vegetableCollection}else if(t=="1"){var o=new app.Item(e[r]);o.set("date",c(o,"1"));app.meatCollection.add(o);s="items-1";n=app.meatCollection}else if(t=="2"){var o=new app.Item(e[r]);o.set("date",c(o,"2"));app.soupCollection.add(o);s="items-2";n=app.soupCollection}else if(t=="3"){var l=new app.Tuan(e[r]);l.set("date",c(l,"3"));app.specialityCollection.add(l);s="items-3";n=app.specialityCollection}}if(t=="0"||t=="1"||t=="2"){var p=new app.ItemListView({model:n,id:s,hasPic:this.hasPic})}else if(t=="3"){var d=new app.TuanListView({model:n,id:s,hasPic:this.hasPic})}function c(e,t){var a;var i=["零","一","二","三","四","五","六","日"];if(t=="0"||t=="1"||t=="2"){a=new Date;var n=new Date(a.getTime()+864e5);var s=n.getMonth()+1,r=n.getDate(),o=n.getDay();return s+"月"+r+"日"}else if(t=="3"){a=new Date(parseInt(e.get("Tutetuan").time)*1e3);var s=a.getMonth()+1,r=a.getDate(),o=a.getDay();return s+"月"+r+"日"}}},showVegetables:function(){$(".types ul li").removeClass("active");$("#vegetable").addClass("active");$(".items").hide();$(".tuans").hide();$(window).scrollTop(0);if($("#items-0").length>0){$("#items-0").show()}else{this.renderList(0)}},showMeat:function(){$(".types ul li").removeClass("active");$("#meat").addClass("active");$(".items").hide();$(".tuans").hide();$(window).scrollTop(0);if($("#items-1").length>0){$("#items-1").show()}else{this.renderList(1)}},showSoup:function(){$(".types ul li").removeClass("active");$("#soup").addClass("active");$(".items").hide();$(".tuans").hide();$(window).scrollTop(0);if($("#items-2").length>0){$("#items-2").show()}else{this.renderList(2)}},showSpeciality:function(){$(".types ul li").removeClass("active");$("#speciality").addClass("active");$(".items").hide();$(window).scrollTop(0);if($("#items-3").length>0){$("#items-3").show()}else{this.renderList(3)}}});app.OrderItemView=Backbone.View.extend({tagName:"li",template:_.template($("#orderItemView-template").html()),events:{"click .minus":"minus","click .add":"add","click .delete-btn":"removeItem"},initialize:function(){if(!this.model.get("count")){this.model.set("count",1);this.model.set("total",parseInt(this.model.get("Material").price))}},render:function(){this.$el.html(this.template(this.model.toJSON()));if(this.model.get("count")>1){this.$el.find(".minus").removeClass("disabled")}return this},minus:function(){var e=parseInt(this.$el.find(".amount").val());if(e>2){this.$el.find(".amount").val(e-1);this.$el.find(".minus").removeClass("disabled")}else if(e==2){this.$el.find(".amount").val(e-1);this.$el.find(".minus").addClass("disabled")}else{this.$el.find(".minus").addClass("disabled");return}this.model.set("count",e-1);this.model.set("total",this.model.get("total")-parseInt(this.model.get("Material").price));app.shoppingCart.set("item_count",app.shoppingCart.get("item_count")-1);app.shoppingCart.set("item_total",app.shoppingCart.get("item_total")-parseInt(this.model.get("Material").price));this.updateView(-1)},add:function(){var e=parseInt(this.$el.find(".amount").val());this.$el.find(".amount").val(e+1);if(e+1>0){this.$el.find(".minus").removeClass("disabled")}else{this.$el.find(".minus").addClass("disabled")}this.model.set("count",e+1);this.model.set("total",this.model.get("total")+parseInt(this.model.get("Material").price));app.shoppingCart.set("item_count",app.shoppingCart.get("item_count")+1);app.shoppingCart.set("item_total",app.shoppingCart.get("item_total")+parseInt(this.model.get("Material").price));this.updateView(1)},removeItem:function(){var e=this.model.get("Cookbook").id;if($("#item-"+e).find(".select-shadow").length>0){$("#item-"+e).find(".select-shadow").css("display","none")}if($("#item-"+e).find(".select-shadow-no-img").length>0){$("#item-"+e).find(".select-shadow-no-img").css("display","none")}app.shoppingCart.get("items").remove(this.model);this.remove();if(app.shoppingCart.get("count")==0){$("#order-container").hide();$("#menu-container").show()}},updateView:function(e){this.$el.find(".item-amount").html(this.model.get("count"));this.$el.find(".item-total-price").html("￥"+this.model.get("total"))}});app.OrderTuanView=Backbone.View.extend({tagName:"li",template:_.template($("#orderTuanView-template").html()),events:{"click .minus":"minus","click .add":"add","click .delete-btn":"removeItem"},initialize:function(){if(!this.model.get("count")){this.model.set("count",1);this.model.set("total",parseInt(this.model.get("Tutetuan").price))}},render:function(){this.$el.html(this.template(this.model.toJSON()));if(this.model.get("count")>1){this.$el.find(".minus").removeClass("disabled")}return this},minus:function(){var e=parseInt(this.$el.find(".amount").val());if(e>2){this.$el.find(".amount").val(e-1);this.$el.find(".minus").removeClass("disabled")}else if(e==2){this.$el.find(".amount").val(e-1);this.$el.find(".minus").addClass("disabled")}else{this.$el.find(".minus").addClass("disabled");return}this.model.set("count",e-1);this.model.set("total",this.model.get("total")-parseInt(this.model.get("Tutetuan").price));app.shoppingCart.set("tuan_count",app.shoppingCart.get("tuan_count")-1);app.shoppingCart.set("tuan_total",app.shoppingCart.get("tuan_total")-parseInt(this.model.get("Tutetuan").price));this.updateView(-1)},add:function(){var e=parseInt(this.$el.find(".amount").val());this.$el.find(".amount").val(e+1);if(e+1>0){this.$el.find(".minus").removeClass("disabled")}else{this.$el.find(".minus").addClass("disabled")}this.model.set("count",e+1);this.model.set("total",this.model.get("total")+parseInt(this.model.get("Tutetuan").price));app.shoppingCart.set("tuan_count",app.shoppingCart.get("tuan_count")+1);app.shoppingCart.set("tuan_total",app.shoppingCart.get("tuan_total")+parseInt(this.model.get("Tutetuan").price));this.updateView(1)},removeItem:function(){var e=this.model.get("Tutetuan").id;if($("#tuan-"+e).find(".select-shadow").length>0){$("#tuan-"+e).find(".select-shadow").css("display","none")}if($("#tuan-"+e).find(".select-shadow-no-img").length>0){$("#tuan-"+e).find(".select-shadow-no-img").css("display","none")}app.shoppingCart.get("tuans").remove(this.model);this.remove();if(app.shoppingCart.get("count")==0){$("#order-container").hide();$("#menu-container").show()}},updateView:function(e){this.$el.find(".tuan-amount").html(this.model.get("count"));this.$el.find(".tuan-total-price").html("￥"+this.model.get("total"))}});app.OrderView=Backbone.View.extend({className:"container",id:"order-container",template:_.template($("#orderView-template").html()),events:{"click .back":"back","click .next":"next"},initialize:function(){$(window).scrollTop(0);$(".main-container").append(this.render().el);sc.dropdown("order-container",".user")},render:function(){this.$el.html(this.template(this.model.toJSON()));var e=this;var t=this.model.get("items");t.forEach(function(t){var a=new app.OrderItemView({model:t});e.$el.find("#item-list").find("ul").append(a.render().el)});var a=this.model.get("tuans");a.forEach(function(t){var a=new app.OrderTuanView({model:t});e.$el.find("#tuan-list").find("ul").append(a.render().el)});if(t.length===0){this.$el.find("#item-list").css("display","none")}if(a.length===0){this.$el.find("#tuan-list").css("display","none")}return this},back:function(){this.$el.css("display","none");$("#menu-container").css("display","block")},next:function(){this.$el.css("display","none");var e=$("#delivery-container");if(e.length>0){e.css("display","block")}else{app.UserInfo=new app.User;var e=new app.DeliveryView({model:app.UserInfo})}}});app.OrderInfoPopupView=Backbone.View.extend({className:"popup",id:"orderInfo-popup",template:_.template($("#orderInfoPopupView-template").html()),events:{"click button":"close"},initialize:function(e){this.msg=e.msg},render:function(){this.$el.html(this.template());this.$el.find(".popup-header").append(this.msg);var e=this;setTimeout(function(){e.close()},2e3);return this},close:function(){this.$el.remove()}});app.OrderConfirmPopupView=Backbone.View.extend({className:"popup",id:"orderConfirm-popup",template:_.template($("#orderConfirmPopupView-template").html()),events:{"click #yes":"submit","click #no":"close"},initialize:function(e,t){if(e!=undefined){if(e.msg)this.msg=e.msg;if(e.tips)this.tips=e.tips;if(e.yesLabel)this.yesLabel=e.yesLabel;if(e.noLabel)this.noLabel=e.noLabel}if(t!=undefined){this.ajaxSetting=t}},render:function(){this.$el.html(this.template());if(this.msg)this.$el.find(".popup-header").append(this.msg);if(this.tips)this.$el.find(".popup-tips").append(this.tips);if(this.yesLabel)this.$el.find("#yes").html(this.yesLabel);if(this.noLabel)this.$el.find("#no").html(this.noLabel);return this},submit:function(){var e=this;$.ajax(e.ajaxSetting);this.$el.remove()},close:function(){this.$el.remove()}});app.PaymentView=Backbone.View.extend({className:"payment",template:_.template($("#paymentView-template").html()),events:{"click #online-payment":"selectOnline","click #cool-payment":"selectCool"},initialize:function(){},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},selectOnline:function(){var e=new app.OrderInfoPopupView({msg:"努力开发中，会在近期上线哦~ ^_^"});this.$el.append(e.render().el)},selectCool:function(){this.$el.find(".radio").removeClass("selected");this.$el.find("#cool-payment > .radio").addClass("selected")}});app.DeliveryView=Backbone.View.extend({className:"container",id:"delivery-container",template:_.template($("#deliveryView-template").html()),events:{"click .back":"back","click .next":"next"},initialize:function(){$(window).scrollTop(0);$(".main-container").append(this.render().el);var e=new app.Payment;var t=new app.PaymentView({model:e});this.$el.find(".confirmation-form").after(t.render().el);sc.dropdown("delivery-container",".user")},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},back:function(){this.$el.css("display","none");$("#order-container").css("display","block")},next:function(){var that=this;var pass=true;if(this.userInfoChanged){pass=this.updateUserInfo()}if(current_user===sc.getWechatId()){if(pass){var postData=this.extractData();$.ajax({url:$("base").attr("src")+"orders/add/"+(new Date).getTime(),method:"post",data:postData,success:function(data){var data=eval("("+data+")");that.$el.css("display","none");if(data.data.cart_id){app.shoppingCart.set("cart_id",data.data.cart_id)}else{app.shoppingCart.set("cart_id","")}if(data.data.tuan_id){app.shoppingCart.get("tuans").forEach(function(e){e.set("tuan_id",data.data.tuan_id)})}else{app.shoppingCart.get("tuans").forEach(function(e){e.set("tuan_id","")})}var orderResultView=new app.OrderResultView({model:app.shoppingCart})},error:function(e){console.log(e)}})}}else if(current_user&&user_status=="NEW_USER"){that.$el.hide();app.registerView=new app.RegisterView({backTo:"delivery-container"})}else if(current_user&&user_status=="CUSTOMER"){that.$el.hide();app.loginView=new app.LoginView({backTo:"delivery-container"})}else if(current_user==undefined){var pop=new app.OrderInfoPopupView({msg:"错误的用户，请重新关注小农女送菜^_^"});that.$el.append(pop.render().el)}},updateUserInfo:function(){var e=this;var t=/^1[3|4|5|8][0-9]{9}$/;var a=e.$el.find("input[name=tel]").val(),i=e.$el.find("input[name=username]").val(),n=e.$el.find("input[name=addr]").val();if(t.exec(a)&&i!=""&&n!=""){$.ajax({url:$("base").attr("src")+"customers/edit/"+this.getUuid(),method:"post",data:{Customer:{wechat_id:e.getWechatId(),name:e.$el.find("input[name=username]").val(),phone:e.$el.find("input[name=tel]").val(),location:e.$el.find("select[name=district]").val()+"-"+e.$el.find("input[name=addr]").val(),remark:e.$el.find("input[name=note]").val()}},success:function(t){e.userInfoChanged=true},error:function(){console.log("error")}});return true}else if(i==""){e.$el.find("input[name=username]").css("color","red");e.$el.find("input[name=username]").focus();e.$el.find("input[name=username]").bind("change",function(){$(this).css("color","black");$(this).unbind("change")});return false}else if(!t.exec(a)){e.$el.find("input[name=tel]").css("color","red");e.$el.find("input[name=tel]").focus();e.$el.find("input[name=tel]").bind("change",function(){$(this).css("color","black");$(this).unbind("change")});return false}else if(n==""){e.$el.find("input[name=addr]").css("color","red");e.$el.find("input[name=addr]").focus();e.$el.find("input[name=addr]").bind("change",function(){$(this).css("color","black");$(this).unbind("change")});return false}},getUuid:function(){return function(){var e=window.location.search;var t=e.substr(1,e.length).split("&");for(var a=0;a<t.length;a++){var i=t[a].split("=");if(i[0]=="code"){return unescape(i[1])}}}()},getWechatId:function(){return function(){var e=document.cookie.split("; ");for(var t=0;t<e.length;t++){var a=e[t].split("=");if(a[0]=="wechat_id")return unescape(a[1])}}()},userInfoChanged:function(){return true},extractData:function(){var e=app.shoppingCart;var t={Cart:[],Tuan:[]};e.get("items").forEach(function(e){var a={};a.cookbook_id=e.get("Cookbook").id;a.material_id=e.get("Material").id;a.count=e.get("count");t.Cart.push(a)});e.get("tuans").forEach(function(e){var a={};a.id=e.get("Tutetuan").id;a.count=e.get("count");t.Tuan.push(a)});return t}});app.OrderResultView=Backbone.View.extend({className:"container",id:"orderResult-container",template:_.template($("#orderResultView-template").html()),events:{"click .next":"nextOrder"},initialize:function(e){$(window).scrollTop(0);$(".main-container").append(this.render().el);sc.dropdown("orderResult-container",".user");var t=new Date;$(".date").html(t.getMonth()+1+"月"+t.getDate()+"日 "+t.getHours()+":"+t.getMinutes())},render:function(){this.$el.html(this.template(this.model.toJSON()));var e=this;var t=this.model.get("items");if(t.length>0){var a=new app.ItemsResultView({model:this.model});e.$el.find(".orderResultList-container").append(a.render().el);t.forEach(function(t){var a=new app.ResultItemView({model:t});e.$el.find("#item-order-list").find("ul").append(a.render().el)})}var i=this.model.get("tuans");if(i.length>0){i.forEach(function(t){var a=new app.TuansResultView({model:t});e.$el.find(".orderResultList-container").append(a.render().el);var i=new app.ResultTuanView({model:t});a.$el.find("#tuan-order-list").find("ul").append(i.render().el)})}if(t.length===0){this.$el.find("#items-order-result").css("display","none")}if(i.length===0){this.$el.find("#tuans-order-result").css("display","none")}return this},nextOrder:function(){window.location.reload()}});app.ItemsResultView=Backbone.View.extend({template:_.template($("#itemsResultView-template").html()),events:{"click .cancelOrder":"cancelOrder"},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},cancelOrder:function(){var that=this;var cart_id=this.model.get("cart_id");var confirm=new app.OrderConfirmPopupView({msg:"确定取消订单吗？"},{url:$("base").attr("src")+"orders/delete/"+cart_id,method:"post",success:function(data){console.log(data);var data=eval("("+data+")");if(data.code==1){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#orderResult-container").append(popup.render().el)}else{if(data.msg=="订单删除成功"){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#orderResult-container").append(popup.render().el);
that.$el.remove()}else{var popup=new app.OrderInfoPopupView({msg:data.msg});$("#orderResult-container").append(popup.render().el)}}},error:function(e){console.log(e)}});$("#orderResult-container").append(confirm.render().el)}});app.TuansResultView=Backbone.View.extend({template:_.template($("#tuansResultView-template").html()),events:{"click .cancelOrder":"cancelOrder"},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},cancelOrder:function(){var that=this;var tuan_id=this.model.get("tuan_id");var confirm=new app.OrderConfirmPopupView({msg:"确定取消订单吗？"},{url:$("base").attr("src")+"orders/delete/"+tuan_id,method:"post",success:function(data){console.log(data);var data=eval("("+data+")");if(data.code==1){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#orderResult-container").append(popup.render().el)}else{if(data.msg=="订单删除成功"){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#orderResult-container").append(popup.render().el);that.$el.remove()}else{var popup=new app.OrderInfoPopupView({msg:data.msg});$("#orderResult-container").append(popup.render().el)}}},error:function(e){console.log(e)}});$("#orderResult-container").append(confirm.render().el)}});app.ResultItemView=Backbone.View.extend({tagName:"li",template:_.template($("#resultItemView-template").html()),render:function(){this.$el.html(this.template(this.model.toJSON()));return this}});app.ResultTuanView=Backbone.View.extend({tagName:"li",template:_.template($("#resultTuanView-template").html()),render:function(){this.$el.html(this.template(this.model.toJSON()));return this}});app.MyOrdersView=Backbone.View.extend({className:"container",id:"myOrders-container",template:_.template($("#myOrdersView-template").html()),events:{"click .next":"next","click .history-loader":"loadHistory"},initialize:function(){$(window).scrollTop(0);var e=this;var t=new Date;this.cur_date=parseInt(t.getFullYear()+""+sc.normalizeNumber(t.getMonth()+1)+""+sc.normalizeNumber(t.getDate()));this.cur_time=t.getHours();$.ajax({url:$("base").attr("src")+"orders/"+this.cur_date+".json",success:function(t){e.rt_data=t.rt_obj.data;e.date=t.rt_obj.date;e.code=t.rt_obj.code;$(".main-container").append(e.render().el);sc.dropdown("myOrders-container",".user")},error:function(){console.log("error")}})},render:function(){this.$el.html(this.template());if(this.code!=2){this.parseOrder()}return this},next:function(){window.location.reload()},loadHistory:function(){var e=this;if(this.code!=2){$.ajax({url:$("base").attr("src")+"orders/"+e.date+".json",success:function(t){e.rt_data=t.rt_obj.data;e.date=t.rt_obj.date;e.code=t.rt_obj.code;if(e.code!=2){e.parseOrder()}},error:function(){console.log("error")}})}},parseOrder:function(){if(this.code!=1&&this.code!=2){if(this.rt_data.cart||this.rt_data.tuan){var e=new app.OneDayOrderView;this.$el.find(".myOrderList").append(e.render().el)}if(this.rt_data.cart){var t=new app.Order(this.rt_data.cart);var a=" 处理中";var i=this.getDateStr(this.date,2);if(this.cur_date>i){a=" 已配送"}else if(this.cur_date==i){if(this.cur_time<6){a=" 采购中"}else if(this.cur_time>=6&&this.cur_time<16){a=" 已采购"}else if(this.cur_time>=16&&this.cur_time<19){a=" 配送中"}else if(this.cur_time>=19){a=" 已配送"}}t.set("order_status",this.getDateStr(this.date,1)+a);t.set("cart_id",this.rt_data.cart_id);t.set("cart_total",this.rt_data.cart_total);var n=new app.ItemOrderView({model:t,status:a});e.$el.find(".orderResult-form").append(n.render().el);for(var s=0;s<this.rt_data.cart.length;s++){var r=new app.Item(this.rt_data.cart[s]);r.set("count",parseInt(r.get("Cart").count));r.set("total",r.get("count")*parseInt(r.get("Material").price));r.set("total",r.get("Material").price);var o=new app.ResultItemView({model:r});n.$el.find("ul").append(o.render().el)}}if(this.rt_data.tuan){var l=this.divideTuan(this.rt_data.tuan);for(var p in l){e.$el.find(".orderResult-form").append('<div class="dotted-divider"></div>');var a=" 处理中";var i=l[p][0].Tutetuan.deliver_date;if(this.cur_date>i){a=" 已配送"}else if(this.cur_date==i){if(this.cur_time<6){a=" 采购中"}else if(this.cur_time>=6&&this.cur_time<16){a=" 已采购"}else if(this.cur_time>=16&&this.cur_time<19){a=" 配送中"}else if(this.cur_time>=19){a=" 已配送"}}var t=new app.Order(this.rt_data.tuan);t.set("tuan_id",this.rt_data.tuan_id);t.set("order_status",this.getDateStr(this.date,1)+a);t.set("tuan_total",l[p].total);var d=new app.TuanOrderView({model:t,status:a});e.$el.find(".orderResult-form").append(d.render().el);for(var s=0;s<l[p].length;s++){var c=new app.Tuan(l[p][s]);c.set("count",parseInt(c.get("TutetuanCart").number));c.set("total",c.get("count")*parseInt(c.get("Tutetuan").price));c.set("total",c.get("Tutetuan").price);var u=new app.ResultTuanView({model:c});d.$el.find("ul").append(u.render().el)}}}}},getDateStr:function(e,t){e=""+e;var a=e.substr(0,4);var i=e.substr(4,2);var n=e.substr(6,2);var s=new Date(a,i,n);s.setDate(s.getDate()+t);var r=s.getFullYear();var o=s.getMonth();if(o<10){o="0"+o}var l=s.getDate();if(l<10){l="0"+l}return parseInt(r+""+o+""+l)},divideTuan:function(e){var t=new Array;var a={};for(var i=0;i<e.length;i++){if(t.indexOf(e[i].Tutetuan.id)==-1){t.push(e[i].Tutetuan.id);a["tuan_"+e[i].Tutetuan.id]=new Array;a["tuan_"+e[i].Tutetuan.id].total=0;a["tuan_"+e[i].Tutetuan.id].push(e[i])}else{a["tuan_"+e[i].Tutetuan.id].push(e[i])}a["tuan_"+e[i].Tutetuan.id].total+=parseInt(e[i].TutetuanCart.number)*parseInt(e[i].Tutetuan.price)}return a}});app.OneDayOrderView=Backbone.View.extend({template:_.template($("#oneDayOrderView-template").html()),render:function(){this.$el.html(this.template());return this}});app.ItemOrderView=Backbone.View.extend({template:_.template($("#itemOrderView-template").html()),events:{"click .cancelOrder":"cancelOrder"},initialize:function(e){if(e!=undefined){this.status=e.status}},render:function(){this.$el.html(this.template(this.model.toJSON()));if(this.status&&this.status.trim()=="已配送"){this.$el.find(".cancelOrder").remove()}return this},cancelOrder:function(){var that=this;var cart_id=this.model.get("cart_id");if(that.status.trim()=="处理中"||that.status.trim()=="采购中"){var confirm=new app.OrderConfirmPopupView({msg:"确定取消订单吗？"},{url:$("base").attr("src")+"orders/delete/"+cart_id,method:"post",success:function(data){var data=eval("("+data+")");if(data.code==1){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el)}else{if(data.msg=="订单删除成功"){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el);that.$el.remove()}else{var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el)}}},error:function(e){console.log(e)}});$("#myOrders-container").append(confirm.render().el)}else if(that.status.trim()=="已采购"){var confirm=new app.OrderConfirmPopupView({msg:"您的订单我们已采购",tips:"现在取消会造成我们的损失",yesLabel:"取消订单",noLabel:"保留订单"},{url:$("base").attr("src")+"orders/delete/"+cart_id,method:"post",success:function(data){var data=eval("("+data+")");if(data.code==1){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el)}else{if(data.msg=="订单删除成功"){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el);that.$el.remove()}else{var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el)}}},error:function(e){console.log(e)}});$("#myOrders-container").append(confirm.render().el)}else if(that.status.trim()=="配送中"){var popup=new app.OrderInfoPopupView({msg:"您的订单已经开始配送"});$("#myOrders-container").append(popup.render().el)}else if(that.status.trim()=="已配送"){var popup=new app.OrderInfoPopupView({msg:"订单已经配送成功，不能取消"});$("#myOrders-container").append(popup.render().el)}}});app.TuanOrderView=Backbone.View.extend({template:_.template($("#tuanOrderView-template").html()),events:{"click .cancelOrder":"cancelOrder"},initialize:function(e){if(e!=undefined){this.status=e.status}},render:function(){this.$el.html(this.template(this.model.toJSON()));if(this.status&&this.status.trim()=="已配送"){this.$el.find(".cancelOrder").remove()}return this},cancelOrder:function(){var that=this;var tuan_id=this.model.get("tuan_id");if(that.status.trim()=="采购中"||that.status.trim()=="处理中"){var confirm=new app.OrderConfirmPopupView({msg:"确定取消订单吗？"},{url:$("base").attr("src")+"orders/delete/"+tuan_id,method:"post",success:function(data){var data=eval("("+data+")");if(data.code==1){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el)}else{if(data.msg=="订单删除成功"){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el);that.$el.remove()}else{var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el)}}},error:function(e){console.log(e)}});$("#myOrders-container").append(confirm.render().el)}else if(that.status.trim()=="已采购"){var confirm=new app.OrderConfirmPopupView({msg:"您的订单我们已采购",tips:"现在取消会造成我们的损失",yesLabel:"取消订单",noLabel:"保留订单"},{url:$("base").attr("src")+"orders/delete/"+cart_id,method:"post",success:function(data){var data=eval("("+data+")");if(data.code==1){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el)}else{if(data.msg=="订单删除成功"){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el);that.$el.remove()}else{var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el)}}},error:function(e){console.log(e)}});$("#myOrders-container").append(confirm.render().el)}else if(that.status.trim()=="配送中"){var popup=new app.OrderInfoPopupView({msg:"您的订单已经开始配送"});$("#myOrders-container").append(popup.render().el)}else if(that.status.trim()=="已配送"){var popup=new app.OrderInfoPopupView({msg:"订单已经配送成功，不能取消"});$("#myOrders-container").append(popup.render().el)}}});