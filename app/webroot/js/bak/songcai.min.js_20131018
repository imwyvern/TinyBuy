function FastClick(t){var e,n=this;this.trackingClick=false;this.trackingClickStart=0;this.targetElement=null;this.touchStartX=0;this.touchStartY=0;this.lastTouchIdentifier=0;this.touchBoundary=10;this.layer=t;if(!t||!t.nodeType){throw new TypeError("Layer must be a document node")}this.onClick=function(){return FastClick.prototype.onClick.apply(n,arguments)};this.onMouse=function(){return FastClick.prototype.onMouse.apply(n,arguments)};this.onTouchStart=function(){return FastClick.prototype.onTouchStart.apply(n,arguments)};this.onTouchEnd=function(){return FastClick.prototype.onTouchEnd.apply(n,arguments)};this.onTouchCancel=function(){return FastClick.prototype.onTouchCancel.apply(n,arguments)};if(FastClick.notNeeded(t)){return}if(this.deviceIsAndroid){t.addEventListener("mouseover",this.onMouse,true);t.addEventListener("mousedown",this.onMouse,true);t.addEventListener("mouseup",this.onMouse,true)}t.addEventListener("click",this.onClick,true);t.addEventListener("touchstart",this.onTouchStart,false);t.addEventListener("touchend",this.onTouchEnd,false);t.addEventListener("touchcancel",this.onTouchCancel,false);if(!Event.prototype.stopImmediatePropagation){t.removeEventListener=function(e,n,i){var r=Node.prototype.removeEventListener;if(e==="click"){r.call(t,e,n.hijacked||n,i)}else{r.call(t,e,n,i)}};t.addEventListener=function(e,n,i){var r=Node.prototype.addEventListener;if(e==="click"){r.call(t,e,n.hijacked||(n.hijacked=function(t){if(!t.propagationStopped){n(t)}}),i)}else{r.call(t,e,n,i)}}}if(typeof t.onclick==="function"){e=t.onclick;t.addEventListener("click",function(t){e(t)},false);t.onclick=null}}FastClick.prototype.deviceIsAndroid=navigator.userAgent.indexOf("Android")>0;FastClick.prototype.deviceIsIOS=/iP(ad|hone|od)/.test(navigator.userAgent);FastClick.prototype.deviceIsIOS4=FastClick.prototype.deviceIsIOS&&/OS 4_\d(_\d)?/.test(navigator.userAgent);FastClick.prototype.deviceIsIOSWithBadTarget=FastClick.prototype.deviceIsIOS&&/OS ([6-9]|\d{2})_\d/.test(navigator.userAgent);FastClick.prototype.needsClick=function(t){switch(t.nodeName.toLowerCase()){case"button":case"select":case"textarea":if(t.disabled){return true}break;case"input":if(this.deviceIsIOS&&t.type==="file"||t.disabled){return true}break;case"label":case"video":return true}return/\bneedsclick\b/.test(t.className)};FastClick.prototype.needsFocus=function(t){switch(t.nodeName.toLowerCase()){case"textarea":case"select":return true;case"input":switch(t.type){case"button":case"checkbox":case"file":case"image":case"radio":case"submit":return false}return!t.disabled&&!t.readOnly;default:return/\bneedsfocus\b/.test(t.className)}};FastClick.prototype.sendClick=function(t,e){var n,i;if(document.activeElement&&document.activeElement!==t){document.activeElement.blur()}i=e.changedTouches[0];n=document.createEvent("MouseEvents");n.initMouseEvent("click",true,true,window,1,i.screenX,i.screenY,i.clientX,i.clientY,false,false,false,false,0,null);n.forwardedTouchEvent=true;t.dispatchEvent(n)};FastClick.prototype.focus=function(t){var e;if(this.deviceIsIOS&&t.setSelectionRange){e=t.value.length;t.setSelectionRange(e,e)}else{t.focus()}};FastClick.prototype.updateScrollParent=function(t){var e,n;e=t.fastClickScrollParent;if(!e||!e.contains(t)){n=t;do{if(n.scrollHeight>n.offsetHeight){e=n;t.fastClickScrollParent=n;break}n=n.parentElement}while(n)}if(e){e.fastClickLastScrollTop=e.scrollTop}};FastClick.prototype.getTargetElementFromEventTarget=function(t){if(t.nodeType===Node.TEXT_NODE){return t.parentNode}return t};FastClick.prototype.onTouchStart=function(t){var e,n,i;if(t.targetTouches.length>1){return true}e=this.getTargetElementFromEventTarget(t.target);n=t.targetTouches[0];if(this.deviceIsIOS){i=window.getSelection();if(i.rangeCount&&!i.isCollapsed){return true}if(!this.deviceIsIOS4){if(n.identifier===this.lastTouchIdentifier){t.preventDefault();return false}this.lastTouchIdentifier=n.identifier;this.updateScrollParent(e)}}this.trackingClick=true;this.trackingClickStart=t.timeStamp;this.targetElement=e;this.touchStartX=n.pageX;this.touchStartY=n.pageY;if(t.timeStamp-this.lastClickTime<200){t.preventDefault()}return true};FastClick.prototype.touchHasMoved=function(t){var e=t.changedTouches[0],n=this.touchBoundary;if(Math.abs(e.pageX-this.touchStartX)>n||Math.abs(e.pageY-this.touchStartY)>n){return true}return false};FastClick.prototype.findControl=function(t){if(t.control!==undefined){return t.control}if(t.htmlFor){return document.getElementById(t.htmlFor)}return t.querySelector("button, input:not([type=hidden]), keygen, meter, output, progress, select, textarea")};FastClick.prototype.onTouchEnd=function(t){var e,n,i,r,a,o=this.targetElement;if(this.touchHasMoved(t)){this.trackingClick=false;this.targetElement=null}if(!this.trackingClick){return true}if(t.timeStamp-this.lastClickTime<200){this.cancelNextClick=true;return true}this.lastClickTime=t.timeStamp;n=this.trackingClickStart;this.trackingClick=false;this.trackingClickStart=0;if(this.deviceIsIOSWithBadTarget){a=t.changedTouches[0];o=document.elementFromPoint(a.pageX-window.pageXOffset,a.pageY-window.pageYOffset)}i=o.tagName.toLowerCase();if(i==="label"){e=this.findControl(o);if(e){this.focus(o);if(this.deviceIsAndroid){return false}o=e}}else{if(this.needsFocus(o)){if(t.timeStamp-n>100||this.deviceIsIOS&&window.top!==window&&i==="input"){this.targetElement=null;return false}this.focus(o);if(!this.deviceIsIOS4||i!=="select"){this.targetElement=null;t.preventDefault()}return false}}if(this.deviceIsIOS&&!this.deviceIsIOS4){r=o.fastClickScrollParent;if(r&&r.fastClickLastScrollTop!==r.scrollTop){return true}}if(!this.needsClick(o)){t.preventDefault();this.sendClick(o,t)}return false};FastClick.prototype.onTouchCancel=function(){this.trackingClick=false;this.targetElement=null};FastClick.prototype.onMouse=function(t){if(!this.targetElement){return true}if(t.forwardedTouchEvent){return true}if(!t.cancelable){return true}if(!this.needsClick(this.targetElement)||this.cancelNextClick){if(t.stopImmediatePropagation){t.stopImmediatePropagation()}else{t.propagationStopped=true}t.stopPropagation();t.preventDefault();return false}return true};FastClick.prototype.onClick=function(t){var e;if(this.trackingClick){this.targetElement=null;this.trackingClick=false;return true}if(t.target.type==="submit"&&t.detail===0){return true}e=this.onMouse(t);if(!e){this.targetElement=null}return e};FastClick.prototype.destroy=function(){var t=this.layer;if(this.deviceIsAndroid){t.removeEventListener("mouseover",this.onMouse,true);t.removeEventListener("mousedown",this.onMouse,true);t.removeEventListener("mouseup",this.onMouse,true)}t.removeEventListener("click",this.onClick,true);t.removeEventListener("touchstart",this.onTouchStart,false);t.removeEventListener("touchend",this.onTouchEnd,false);t.removeEventListener("touchcancel",this.onTouchCancel,false)};FastClick.notNeeded=function(t){var e;if(typeof window.ontouchstart==="undefined"){return true}if(/Chrome\/[0-9]+/.test(navigator.userAgent)){if(FastClick.prototype.deviceIsAndroid){e=document.querySelector("meta[name=viewport]");if(e&&e.content.indexOf("user-scalable=no")!==-1){return true}}else{return true}}if(t.style.msTouchAction==="none"){return true}return false};FastClick.attach=function(t){return new FastClick(t)};if(typeof define!=="undefined"&&define.amd){define(function(){return FastClick})}else{if(typeof module!=="undefined"&&module.exports){module.exports=FastClick.attach;module.exports.FastClick=FastClick}else{window.FastClick=FastClick}}(function(t){var e=t.fn.domManip,n="_tmplitem",i=/^[^<]*(<[\w\W]+>)[^>]*$|\{\{\! /,r={},a={},o,l={key:0,data:{}},s=0,c=0,u=[];function p(e,n,i,o){var l={data:o||o===0||o===false?o:n?n.data:{},_wrap:n?n._wrap:null,tmpl:null,parent:n||null,nodes:[],calls:y,nest:C,wrap:w,html:T,update:_};e&&t.extend(l,e,{nodes:[],parent:n});if(i){l.tmpl=i;l._ctnt=l._ctnt||l.tmpl(t,l);l.key=++s;(u.length?a:r)[s]=l}return l}t.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,n){t.fn[e]=function(i){var a=[],l=t(i),s,u,p,f,d=this.length===1&&this[0].parentNode;o=r||{};if(d&&d.nodeType===11&&d.childNodes.length===1&&l.length===1){l[n](this[0]);a=this}else{for(u=0,p=l.length;u<p;u++){c=u;s=(u>0?this.clone(true):this).get();t(l[u])[n](s);a=a.concat(s)}c=0;a=this.pushStack(a,e,l.selector)}f=o;o=null;t.tmpl.complete(f);return a}});t.fn.extend({tmpl:function(e,n,i){return t.tmpl(this[0],e,n,i)},tmplItem:function(){return t.tmplItem(this[0])},template:function(e){return t.template(e,this[0])},domManip:function(n,i,a){if(n[0]&&t.isArray(n[0])){var l=t.makeArray(arguments),s=n[0],u=s.length,p=0,f;while(p<u&&!(f=t.data(s[p++],"tmplItem")));if(f&&c)l[2]=function(e){t.tmpl.afterManip(this,e,a)};e.apply(this,l)}else e.apply(this,arguments);c=0;!o&&t.tmpl.complete(r);return this}});t.extend({tmpl:function(e,n,i,o){var s,c=!o;if(c){o=l;e=t.template[e]||t.template(null,e);a={}}else if(!e){e=o.tmpl;r[o.key]=o;o.nodes=[];o.wrapped&&m(o,o.wrapped);return t(f(o,null,o.tmpl(t,o)))}if(!e)return[];if(typeof n==="function")n=n.call(o||{});i&&i.wrapped&&m(i,i.wrapped);s=t.isArray(n)?t.map(n,function(t){return t?p(i,o,e,t):null}):[p(i,o,e,n)];return c?t(f(o,null,s)):s},tmplItem:function(e){var n;if(e instanceof t)e=e[0];while(e&&e.nodeType===1&&!(n=t.data(e,"tmplItem"))&&(e=e.parentNode));return n||l},template:function(e,n){if(n){if(typeof n==="string")n=h(n);else if(n instanceof t)n=n[0]||{};if(n.nodeType)n=t.data(n,"tmpl")||t.data(n,"tmpl",h(n.innerHTML));return typeof e==="string"?t.template[e]=n:n}return e?typeof e!=="string"?t.template(null,e):t.template[e]||t.template(null,i.test(e)?e:t(e)):null},encode:function(t){return(""+t).split("<").join("&lt;").split(">").join("&gt;").split('"').join("&#34;").split("'").join("&#39;")}});t.extend(t.tmpl,{tag:{tmpl:{_default:{$2:"null"},open:"if($notnull_1){__=__.concat($item.nest($1,$2));}"},wrap:{_default:{$2:"null"},open:"$item.calls(__,$1,$2);__=[];",close:"call=$item.calls();__=call._.concat($item.wrap(call,__));"},each:{_default:{$2:"$index, $value"},open:"if($notnull_1){$.each($1a,function($2){with(this){",close:"}});}"},"if":{open:"if(($notnull_1) && $1a){",close:"}"},"else":{_default:{$1:"true"},open:"}else if(($notnull_1) && $1a){"},html:{open:"if($notnull_1){__.push($1a);}"},"=":{_default:{$1:"$data"},open:"if($notnull_1){__.push($.encode($1a));}"},"!":{open:""}},complete:function(){r={}},afterManip:function(e,n,i){var r=n.nodeType===11?t.makeArray(n.childNodes):n.nodeType===1?[n]:[];i.call(e,n);k(r);c++}});function f(e,i,r){var a,o=r?t.map(r,function(t){return typeof t==="string"?e.key?t.replace(/(<\w+)(?=[\s>])(?![^>]*_tmplitem)([^>]*)/g,"$1 "+n+'="'+e.key+'" $2'):t:f(t,e,t._ctnt)}):e;if(i)return o;o=o.join("");o.replace(/^\s*([^<\s][^<]*)?(<[\w\W]+>)([^>]*[^>\s])?\s*$/,function(e,n,i,r){a=t(i).get();k(a);if(n)a=d(n).concat(a);if(r)a=a.concat(d(r))});return a?a:d(o)}function d(e){var n=document.createElement("div");n.innerHTML=e;return t.makeArray(n.childNodes)}function h(e){return new Function("jQuery","$item","var $=jQuery,call,__=[],$data=$item.data;with($data){__.push('"+t.trim(e).replace(/([\\'])/g,"\\$1").replace(/[\r\t\n]/g," ").replace(/\$\{([^\}]*)\}/g,"{{= $1}}").replace(/\{\{(\/?)(\w+|.)(?:\(((?:[^\}]|\}(?!\}))*?)?\))?(?:\s+(.*?)?)?(\(((?:[^\}]|\}(?!\}))*?)\))?\s*\}\}/g,function(e,n,i,r,a,o,l){var s=t.tmpl.tag[i],c,u,p;if(!s)throw"Unknown template tag: "+i;c=s._default||[];if(o&&!/\w$/.test(a)){a+=o;o=""}if(a){a=g(a);l=l?","+g(l)+")":o?")":"";u=o?a.indexOf(".")>-1?a+g(o):"("+a+").call($item"+l:a;p=o?u:"(typeof("+a+")==='function'?("+a+").call($item):("+a+"))"}else p=u=c.$1||"null";r=g(r);return"');"+s[n?"close":"open"].split("$notnull_1").join(a?"typeof("+a+")!=='undefined' && ("+a+")!=null":"true").split("$1a").join(p).split("$1").join(u).split("$2").join(r||c.$2||"")+"__.push('"})+"');}return __;")}function m(e,n){e._wrap=f(e,true,t.isArray(n)?n:[i.test(n)?n:t(n).html()]).join("")}function g(t){return t?t.replace(/\\'/g,"'").replace(/\\\\/g,"\\"):null}function v(t){var e=document.createElement("div");e.appendChild(t.cloneNode(true));return e.innerHTML}function k(e){var i="_"+c,o,l,u={},f,d,h;for(f=0,d=e.length;f<d;f++){if((o=e[f]).nodeType!==1)continue;l=o.getElementsByTagName("*");for(h=l.length-1;h>=0;h--)m(l[h]);m(o)}function m(e){var o,l=e,f,d,h;if(h=e.getAttribute(n)){while(l.parentNode&&(l=l.parentNode).nodeType===1&&!(o=l.getAttribute(n)));if(o!==h){l=l.parentNode?l.nodeType===11?0:l.getAttribute(n)||0:0;if(!(d=r[h])){d=a[h];d=p(d,r[l]||a[l]);d.key=++s;r[s]=d}c&&m(h)}e.removeAttribute(n)}else if(c&&(d=t.data(e,"tmplItem"))){m(d.key);r[d.key]=d;l=t.data(e.parentNode,"tmplItem");l=l?l.key:0}if(d){f=d;while(f&&f.key!=l){f.nodes.push(e);f=f.parent}delete d._ctnt;delete d._wrap;t.data(e,"tmplItem",d)}function m(t){t=t+i;d=u[t]=u[t]||p(d,r[d.parent.key+i]||d.parent)}}}function y(t,e,n,i){if(!t)return u.pop();u.push({_:t,tmpl:e,item:this,data:n,options:i})}function C(e,n,i){return t.tmpl(t.template(e),n,i,this)}function w(e,n){var i=e.options||{};i.wrapped=n;return t.tmpl(t.template(e.tmpl),e.data,i,e.item)}function T(e,n){var i=this._wrap;return t.map(t(t.isArray(i)?i.join(""):i).filter(e||"*"),function(t){return n?t.innerText||t.textContent:t.outerHTML||v(t)})}function _(){var e=this.nodes;t.tmpl(null,null,null,this).insertBefore(e[0]);t(e).remove()}})(jQuery);(function(t){t.fn.extend({loadmore:function(e,n){var i={url:"",limit:10,markupId:"markup",itemsId:"items"};e=t.extend(i,e);var r=this;var a=r.find("div.loading");t.ajax({type:"get",url:e.url,dataType:"json",complete:function(){a.addClass("none")},success:function(i){var a=0;t.each(i.items,function(n,i){a++;t("#"+e.itemsId).append(t("#"+e.markupId).tmpl(i))});if(typeof n=="function"){n()}if(a<e.limit){r.addClass("none")}}})}})})(jQuery);jQuery(function(t){FastClick.attach(document.body);t("#nav-group").bind("click",function(){if(t(this).hasClass("focus")){t("#nav-dropdown-groups").hide();t(this).removeClass("focus")}else{t("#nav-dropdown-groups").show();t(this).addClass("focus")}});t("button.navigator").bind("click",function(){location.href=t(this).attr("url")})});function build_query(t,e){var n=get_query_args(t);var i=t.split("?");var r=false;for(var a in e){n[a]=encodeURIComponent(e[a]);if(a=="page"){r=true}}t=i[0]+"?";for(var o in n){if(!(n[o]=="null"||n[o]=="")){if(o=="page"&&r==false){continue}t+=o+"="+n[o]+"&"}}return t.substr(0,t.length-1)}function get_query_args(t){var e=new Object;var n=t.split("?");if(n.length>=2){var i=n[1];var r=i.split("&");for(var a in r){$item=r[a].split("=");e[$item[0]]=$item[1]}}return e}function htmlspecialchars(t){if(typeof t=="string"){t=t.replace(/&/g,"&amp;");t=t.replace(/"/g,"&quot;");t=t.replace(/'/g,"&#039;");t=t.replace(/</g,"&lt;");t=t.replace(/>/g,"&gt;")}return t}function get_rich_text_length(t){var e=document.createElement("DIV");e.innerHTML=t;var n=e.innerText;n=n.replace(/[\n\r]/g,"");return n.length}function showAlert(t){$("#alert > span").html(t);$("#alert").addClass("show");setTimeout("$('#alert').removeClass('show')",2500)}function showTips(t){$("#tips > span").html(t);$("#tips").addClass("show");setTimeout(function(){$("#tips").removeClass("show")},2500)}function isEmail(t){var e=/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((\.[a-zA-Z0-9_-]{2,3}){1,2})$/;return e.test(t)}function isTelephone(t){var e=/^1[3|4|5|8]\d{9}$/;return e.test(t)}function setCookie(t,e,n){var i=new Date;i.setDate(i.getDate()+n);document.cookie=t+"="+escape(e)+(n==null?"":";expires="+i.toGMTString())}
(function(){var n=this;var r=n._;var t={};var e=Array.prototype,i=Object.prototype,u=Function.prototype;var a=e.push,f=e.slice,l=e.concat,c=i.toString,o=i.hasOwnProperty;var s=e.forEach,p=e.map,v=e.reduce,h=e.reduceRight,g=e.filter,y=e.every,m=e.some,d=e.indexOf,b=e.lastIndexOf,x=Array.isArray,_=Object.keys,w=u.bind;var j=function(n){if(n instanceof j)return n;if(!(this instanceof j))return new j(n);this._wrapped=n};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=j}exports._=j}else{n._=j}j.VERSION="1.4.4";var A=j.each=j.forEach=function(n,r,e){if(n==null)return;if(s&&n.forEach===s){n.forEach(r,e)}else if(n.length===+n.length){for(var i=0,u=n.length;i<u;i++){if(r.call(e,n[i],i,n)===t)return}}else{for(var a in n){if(j.has(n,a)){if(r.call(e,n[a],a,n)===t)return}}}};j.map=j.collect=function(n,r,t){var e=[];if(n==null)return e;if(p&&n.map===p)return n.map(r,t);A(n,function(n,i,u){e[e.length]=r.call(t,n,i,u)});return e};var O="Reduce of empty array with no initial value";j.reduce=j.foldl=j.inject=function(n,r,t,e){var i=arguments.length>2;if(n==null)n=[];if(v&&n.reduce===v){if(e)r=j.bind(r,e);return i?n.reduce(r,t):n.reduce(r)}A(n,function(n,u,a){if(!i){t=n;i=true}else{t=r.call(e,t,n,u,a)}});if(!i)throw new TypeError(O);return t};j.reduceRight=j.foldr=function(n,r,t,e){var i=arguments.length>2;if(n==null)n=[];if(h&&n.reduceRight===h){if(e)r=j.bind(r,e);return i?n.reduceRight(r,t):n.reduceRight(r)}var u=n.length;if(u!==+u){var a=j.keys(n);u=a.length}A(n,function(f,l,c){l=a?a[--u]:--u;if(!i){t=n[l];i=true}else{t=r.call(e,t,n[l],l,c)}});if(!i)throw new TypeError(O);return t};j.find=j.detect=function(n,r,t){var e;E(n,function(n,i,u){if(r.call(t,n,i,u)){e=n;return true}});return e};j.filter=j.select=function(n,r,t){var e=[];if(n==null)return e;if(g&&n.filter===g)return n.filter(r,t);A(n,function(n,i,u){if(r.call(t,n,i,u))e[e.length]=n});return e};j.reject=function(n,r,t){return j.filter(n,function(n,e,i){return!r.call(t,n,e,i)},t)};j.every=j.all=function(n,r,e){r||(r=j.identity);var i=true;if(n==null)return i;if(y&&n.every===y)return n.every(r,e);A(n,function(n,u,a){if(!(i=i&&r.call(e,n,u,a)))return t});return!!i};var E=j.some=j.any=function(n,r,e){r||(r=j.identity);var i=false;if(n==null)return i;if(m&&n.some===m)return n.some(r,e);A(n,function(n,u,a){if(i||(i=r.call(e,n,u,a)))return t});return!!i};j.contains=j.include=function(n,r){if(n==null)return false;if(d&&n.indexOf===d)return n.indexOf(r)!=-1;return E(n,function(n){return n===r})};j.invoke=function(n,r){var t=f.call(arguments,2);var e=j.isFunction(r);return j.map(n,function(n){return(e?r:n[r]).apply(n,t)})};j.pluck=function(n,r){return j.map(n,function(n){return n[r]})};j.where=function(n,r,t){if(j.isEmpty(r))return t?null:[];return j[t?"find":"filter"](n,function(n){for(var t in r){if(r[t]!==n[t])return false}return true})};j.findWhere=function(n,r){return j.where(n,r,true)};j.max=function(n,r,t){if(!r&&j.isArray(n)&&n[0]===+n[0]&&n.length<65535){return Math.max.apply(Math,n)}if(!r&&j.isEmpty(n))return-Infinity;var e={computed:-Infinity,value:-Infinity};A(n,function(n,i,u){var a=r?r.call(t,n,i,u):n;a>=e.computed&&(e={value:n,computed:a})});return e.value};j.min=function(n,r,t){if(!r&&j.isArray(n)&&n[0]===+n[0]&&n.length<65535){return Math.min.apply(Math,n)}if(!r&&j.isEmpty(n))return Infinity;var e={computed:Infinity,value:Infinity};A(n,function(n,i,u){var a=r?r.call(t,n,i,u):n;a<e.computed&&(e={value:n,computed:a})});return e.value};j.shuffle=function(n){var r;var t=0;var e=[];A(n,function(n){r=j.random(t++);e[t-1]=e[r];e[r]=n});return e};var k=function(n){return j.isFunction(n)?n:function(r){return r[n]}};j.sortBy=function(n,r,t){var e=k(r);return j.pluck(j.map(n,function(n,r,i){return{value:n,index:r,criteria:e.call(t,n,r,i)}}).sort(function(n,r){var t=n.criteria;var e=r.criteria;if(t!==e){if(t>e||t===void 0)return 1;if(t<e||e===void 0)return-1}return n.index<r.index?-1:1}),"value")};var I=function(n,r,t,e){var i={};var u=k(r||j.identity);A(n,function(r,a){var f=u.call(t,r,a,n);e(i,f,r)});return i};j.groupBy=function(n,r,t){return I(n,r,t,function(n,r,t){(j.has(n,r)?n[r]:n[r]=[]).push(t)})};j.countBy=function(n,r,t){return I(n,r,t,function(n,r){if(!j.has(n,r))n[r]=0;n[r]++})};j.sortedIndex=function(n,r,t,e){t=t==null?j.identity:k(t);var i=t.call(e,r);var u=0,a=n.length;while(u<a){var f=u+a>>>1;t.call(e,n[f])<i?u=f+1:a=f}return u};j.toArray=function(n){if(!n)return[];if(j.isArray(n))return f.call(n);if(n.length===+n.length)return j.map(n,j.identity);return j.values(n)};j.size=function(n){if(n==null)return 0;return n.length===+n.length?n.length:j.keys(n).length};j.first=j.head=j.take=function(n,r,t){if(n==null)return void 0;return r!=null&&!t?f.call(n,0,r):n[0]};j.initial=function(n,r,t){return f.call(n,0,n.length-(r==null||t?1:r))};j.last=function(n,r,t){if(n==null)return void 0;if(r!=null&&!t){return f.call(n,Math.max(n.length-r,0))}else{return n[n.length-1]}};j.rest=j.tail=j.drop=function(n,r,t){return f.call(n,r==null||t?1:r)};j.compact=function(n){return j.filter(n,j.identity)};var F=function(n,r,t){A(n,function(n){if(j.isArray(n)){r?a.apply(t,n):F(n,r,t)}else{t.push(n)}});return t};j.flatten=function(n,r){return F(n,r,[])};j.without=function(n){return j.difference(n,f.call(arguments,1))};j.uniq=j.unique=function(n,r,t,e){if(j.isFunction(r)){e=t;t=r;r=false}var i=t?j.map(n,t,e):n;var u=[];var a=[];A(i,function(t,e){if(r?!e||a[a.length-1]!==t:!j.contains(a,t)){a.push(t);u.push(n[e])}});return u};j.union=function(){return j.uniq(l.apply(e,arguments))};j.intersection=function(n){var r=f.call(arguments,1);return j.filter(j.uniq(n),function(n){return j.every(r,function(r){return j.indexOf(r,n)>=0})})};j.difference=function(n){var r=l.apply(e,f.call(arguments,1));return j.filter(n,function(n){return!j.contains(r,n)})};j.zip=function(){var n=f.call(arguments);var r=j.max(j.pluck(n,"length"));var t=new Array(r);for(var e=0;e<r;e++){t[e]=j.pluck(n,""+e)}return t};j.object=function(n,r){if(n==null)return{};var t={};for(var e=0,i=n.length;e<i;e++){if(r){t[n[e]]=r[e]}else{t[n[e][0]]=n[e][1]}}return t};j.indexOf=function(n,r,t){if(n==null)return-1;var e=0,i=n.length;if(t){if(typeof t=="number"){e=t<0?Math.max(0,i+t):t}else{e=j.sortedIndex(n,r);return n[e]===r?e:-1}}if(d&&n.indexOf===d)return n.indexOf(r,t);for(;e<i;e++)if(n[e]===r)return e;return-1};j.lastIndexOf=function(n,r,t){if(n==null)return-1;var e=t!=null;if(b&&n.lastIndexOf===b){return e?n.lastIndexOf(r,t):n.lastIndexOf(r)}var i=e?t:n.length;while(i--)if(n[i]===r)return i;return-1};j.range=function(n,r,t){if(arguments.length<=1){r=n||0;n=0}t=arguments[2]||1;var e=Math.max(Math.ceil((r-n)/t),0);var i=0;var u=new Array(e);while(i<e){u[i++]=n;n+=t}return u};j.bind=function(n,r){if(n.bind===w&&w)return w.apply(n,f.call(arguments,1));var t=f.call(arguments,2);return function(){return n.apply(r,t.concat(f.call(arguments)))}};j.partial=function(n){var r=f.call(arguments,1);return function(){return n.apply(this,r.concat(f.call(arguments)))}};j.bindAll=function(n){var r=f.call(arguments,1);if(r.length===0)r=j.functions(n);A(r,function(r){n[r]=j.bind(n[r],n)});return n};j.memoize=function(n,r){var t={};r||(r=j.identity);return function(){var e=r.apply(this,arguments);return j.has(t,e)?t[e]:t[e]=n.apply(this,arguments)}};j.delay=function(n,r){var t=f.call(arguments,2);return setTimeout(function(){return n.apply(null,t)},r)};j.defer=function(n){return j.delay.apply(j,[n,1].concat(f.call(arguments,1)))};j.throttle=function(n,r){var t,e,i,u;var a=0;var f=function(){a=new Date;i=null;u=n.apply(t,e)};return function(){var l=new Date;var c=r-(l-a);t=this;e=arguments;if(c<=0){clearTimeout(i);i=null;a=l;u=n.apply(t,e)}else if(!i){i=setTimeout(f,c)}return u}};j.debounce=function(n,r,t){var e,i;return function(){var u=this,a=arguments;var f=function(){e=null;if(!t)i=n.apply(u,a)};var l=t&&!e;clearTimeout(e);e=setTimeout(f,r);if(l)i=n.apply(u,a);return i}};j.once=function(n){var r=false,t;return function(){if(r)return t;r=true;t=n.apply(this,arguments);n=null;return t}};j.wrap=function(n,r){return function(){var t=[n];a.apply(t,arguments);return r.apply(this,t)}};j.compose=function(){var n=arguments;return function(){var r=arguments;for(var t=n.length-1;t>=0;t--){r=[n[t].apply(this,r)]}return r[0]}};j.after=function(n,r){if(n<=0)return r();return function(){if(--n<1){return r.apply(this,arguments)}}};j.keys=_||function(n){if(n!==Object(n))throw new TypeError("Invalid object");var r=[];for(var t in n)if(j.has(n,t))r[r.length]=t;return r};j.values=function(n){var r=[];for(var t in n)if(j.has(n,t))r.push(n[t]);return r};j.pairs=function(n){var r=[];for(var t in n)if(j.has(n,t))r.push([t,n[t]]);return r};j.invert=function(n){var r={};for(var t in n)if(j.has(n,t))r[n[t]]=t;return r};j.functions=j.methods=function(n){var r=[];for(var t in n){if(j.isFunction(n[t]))r.push(t)}return r.sort()};j.extend=function(n){A(f.call(arguments,1),function(r){if(r){for(var t in r){n[t]=r[t]}}});return n};j.pick=function(n){var r={};var t=l.apply(e,f.call(arguments,1));A(t,function(t){if(t in n)r[t]=n[t]});return r};j.omit=function(n){var r={};var t=l.apply(e,f.call(arguments,1));for(var i in n){if(!j.contains(t,i))r[i]=n[i]}return r};j.defaults=function(n){A(f.call(arguments,1),function(r){if(r){for(var t in r){if(n[t]==null)n[t]=r[t]}}});return n};j.clone=function(n){if(!j.isObject(n))return n;return j.isArray(n)?n.slice():j.extend({},n)};j.tap=function(n,r){r(n);return n};var R=function(n,r,t,e){if(n===r)return n!==0||1/n==1/r;if(n==null||r==null)return n===r;if(n instanceof j)n=n._wrapped;if(r instanceof j)r=r._wrapped;var i=c.call(n);if(i!=c.call(r))return false;switch(i){case"[object String]":return n==String(r);case"[object Number]":return n!=+n?r!=+r:n==0?1/n==1/r:n==+r;case"[object Date]":case"[object Boolean]":return+n==+r;case"[object RegExp]":return n.source==r.source&&n.global==r.global&&n.multiline==r.multiline&&n.ignoreCase==r.ignoreCase}if(typeof n!="object"||typeof r!="object")return false;var u=t.length;while(u--){if(t[u]==n)return e[u]==r}t.push(n);e.push(r);var a=0,f=true;if(i=="[object Array]"){a=n.length;f=a==r.length;if(f){while(a--){if(!(f=R(n[a],r[a],t,e)))break}}}else{var l=n.constructor,o=r.constructor;if(l!==o&&!(j.isFunction(l)&&l instanceof l&&j.isFunction(o)&&o instanceof o)){return false}for(var s in n){if(j.has(n,s)){a++;if(!(f=j.has(r,s)&&R(n[s],r[s],t,e)))break}}if(f){for(s in r){if(j.has(r,s)&&!a--)break}f=!a}}t.pop();e.pop();return f};j.isEqual=function(n,r){return R(n,r,[],[])};j.isEmpty=function(n){if(n==null)return true;if(j.isArray(n)||j.isString(n))return n.length===0;for(var r in n)if(j.has(n,r))return false;return true};j.isElement=function(n){return!!(n&&n.nodeType===1)};j.isArray=x||function(n){return c.call(n)=="[object Array]"};j.isObject=function(n){return n===Object(n)};A(["Arguments","Function","String","Number","Date","RegExp"],function(n){j["is"+n]=function(r){return c.call(r)=="[object "+n+"]"}});if(!j.isArguments(arguments)){j.isArguments=function(n){return!!(n&&j.has(n,"callee"))}}if(typeof/./!=="function"){j.isFunction=function(n){return typeof n==="function"}}j.isFinite=function(n){return isFinite(n)&&!isNaN(parseFloat(n))};j.isNaN=function(n){return j.isNumber(n)&&n!=+n};j.isBoolean=function(n){return n===true||n===false||c.call(n)=="[object Boolean]"};j.isNull=function(n){return n===null};j.isUndefined=function(n){return n===void 0};j.has=function(n,r){return o.call(n,r)};j.noConflict=function(){n._=r;return this};j.identity=function(n){return n};j.times=function(n,r,t){var e=Array(n);for(var i=0;i<n;i++)e[i]=r.call(t,i);return e};j.random=function(n,r){if(r==null){r=n;n=0}return n+Math.floor(Math.random()*(r-n+1))};var S={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};S.unescape=j.invert(S.escape);var M={escape:new RegExp("["+j.keys(S.escape).join("")+"]","g"),unescape:new RegExp("("+j.keys(S.unescape).join("|")+")","g")};j.each(["escape","unescape"],function(n){j[n]=function(r){if(r==null)return"";return(""+r).replace(M[n],function(r){return S[n][r]})}});j.result=function(n,r){if(n==null)return null;var t=n[r];return j.isFunction(t)?t.call(n):t};j.mixin=function(n){A(j.functions(n),function(r){var t=j[r]=n[r];j.prototype[r]=function(){var n=[this._wrapped];a.apply(n,arguments);return D.call(this,t.apply(j,n))}})};var N=0;j.uniqueId=function(n){var r=++N+"";return n?n+r:r};j.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var T=/(.)^/;var q={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"};var B=/\\|'|\r|\n|\t|\u2028|\u2029/g;j.template=function(n,r,t){var e;t=j.defaults({},t,j.templateSettings);var i=new RegExp([(t.escape||T).source,(t.interpolate||T).source,(t.evaluate||T).source].join("|")+"|$","g");var u=0;var a="__p+='";n.replace(i,function(r,t,e,i,f){a+=n.slice(u,f).replace(B,function(n){return"\\"+q[n]});if(t){a+="'+\n((__t=("+t+"))==null?'':_.escape(__t))+\n'"}if(e){a+="'+\n((__t=("+e+"))==null?'':__t)+\n'"}if(i){a+="';\n"+i+"\n__p+='"}u=f+r.length;return r});a+="';\n";if(!t.variable)a="with(obj||{}){\n"+a+"}\n";a="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{e=new Function(t.variable||"obj","_",a)}catch(f){f.source=a;throw f}if(r)return e(r,j);var l=function(n){return e.call(this,n,j)};l.source="function("+(t.variable||"obj")+"){\n"+a+"}";return l};j.chain=function(n){return j(n).chain()};var D=function(n){return this._chain?j(n).chain():n};j.mixin(j);A(["pop","push","reverse","shift","sort","splice","unshift"],function(n){var r=e[n];j.prototype[n]=function(){var t=this._wrapped;r.apply(t,arguments);if((n=="shift"||n=="splice")&&t.length===0)delete t[0];return D.call(this,t)}});A(["concat","join","slice"],function(n){var r=e[n];j.prototype[n]=function(){return D.call(this,r.apply(this._wrapped,arguments))}});j.extend(j.prototype,{chain:function(){this._chain=true;return this},value:function(){return this._wrapped}})}).call(this);
(function(){var t=this;var e=t.Backbone;var i=[];var s=i.push;var r=i.slice;var n=i.splice;var a;if(typeof exports!=="undefined"){a=exports}else{a=t.Backbone={}}a.VERSION="0.9.10";var h=t._;if(!h&&typeof require!=="undefined")h=require("underscore");a.$=t.jQuery||t.Zepto||t.ender;a.noConflict=function(){t.Backbone=e;return this};a.emulateHTTP=false;a.emulateJSON=false;var o=/\s+/;var u=function(t,e,i,s){if(!i)return true;if(typeof i==="object"){for(var r in i){t[e].apply(t,[r,i[r]].concat(s))}}else if(o.test(i)){var n=i.split(o);for(var a=0,h=n.length;a<h;a++){t[e].apply(t,[n[a]].concat(s))}}else{return true}};var l=function(t,e){var i,s=-1,r=t.length;switch(e.length){case 0:while(++s<r)(i=t[s]).callback.call(i.ctx);return;case 1:while(++s<r)(i=t[s]).callback.call(i.ctx,e[0]);return;case 2:while(++s<r)(i=t[s]).callback.call(i.ctx,e[0],e[1]);return;case 3:while(++s<r)(i=t[s]).callback.call(i.ctx,e[0],e[1],e[2]);return;default:while(++s<r)(i=t[s]).callback.apply(i.ctx,e)}};var c=a.Events={on:function(t,e,i){if(!(u(this,"on",t,[e,i])&&e))return this;this._events||(this._events={});var s=this._events[t]||(this._events[t]=[]);s.push({callback:e,context:i,ctx:i||this});return this},once:function(t,e,i){if(!(u(this,"once",t,[e,i])&&e))return this;var s=this;var r=h.once(function(){s.off(t,r);e.apply(this,arguments)});r._callback=e;this.on(t,r,i);return this},off:function(t,e,i){var s,r,n,a,o,l,c,f;if(!this._events||!u(this,"off",t,[e,i]))return this;if(!t&&!e&&!i){this._events={};return this}a=t?[t]:h.keys(this._events);for(o=0,l=a.length;o<l;o++){t=a[o];if(s=this._events[t]){n=[];if(e||i){for(c=0,f=s.length;c<f;c++){r=s[c];if(e&&e!==r.callback&&e!==r.callback._callback||i&&i!==r.context){n.push(r)}}}this._events[t]=n}}return this},trigger:function(t){if(!this._events)return this;var e=r.call(arguments,1);if(!u(this,"trigger",t,e))return this;var i=this._events[t];var s=this._events.all;if(i)l(i,e);if(s)l(s,arguments);return this},listenTo:function(t,e,i){var s=this._listeners||(this._listeners={});var r=t._listenerId||(t._listenerId=h.uniqueId("l"));s[r]=t;t.on(e,typeof e==="object"?this:i,this);return this},stopListening:function(t,e,i){var s=this._listeners;if(!s)return;if(t){t.off(e,typeof e==="object"?this:i,this);if(!e&&!i)delete s[t._listenerId]}else{if(typeof e==="object")i=this;for(var r in s){s[r].off(e,i,this)}this._listeners={}}return this}};c.bind=c.on;c.unbind=c.off;h.extend(a,c);var f=a.Model=function(t,e){var i;var s=t||{};this.cid=h.uniqueId("c");this.attributes={};if(e&&e.collection)this.collection=e.collection;if(e&&e.parse)s=this.parse(s,e)||{};if(i=h.result(this,"defaults")){s=h.defaults({},s,i)}this.set(s,e);this.changed={};this.initialize.apply(this,arguments)};h.extend(f.prototype,c,{changed:null,idAttribute:"id",initialize:function(){},toJSON:function(t){return h.clone(this.attributes)},sync:function(){return a.sync.apply(this,arguments)},get:function(t){return this.attributes[t]},escape:function(t){return h.escape(this.get(t))},has:function(t){return this.get(t)!=null},set:function(t,e,i){var s,r,n,a,o,u,l,c;if(t==null)return this;if(typeof t==="object"){r=t;i=e}else{(r={})[t]=e}i||(i={});if(!this._validate(r,i))return false;n=i.unset;o=i.silent;a=[];u=this._changing;this._changing=true;if(!u){this._previousAttributes=h.clone(this.attributes);this.changed={}}c=this.attributes,l=this._previousAttributes;if(this.idAttribute in r)this.id=r[this.idAttribute];for(s in r){e=r[s];if(!h.isEqual(c[s],e))a.push(s);if(!h.isEqual(l[s],e)){this.changed[s]=e}else{delete this.changed[s]}n?delete c[s]:c[s]=e}if(!o){if(a.length)this._pending=true;for(var f=0,d=a.length;f<d;f++){this.trigger("change:"+a[f],this,c[a[f]],i)}}if(u)return this;if(!o){while(this._pending){this._pending=false;this.trigger("change",this,i)}}this._pending=false;this._changing=false;return this},unset:function(t,e){return this.set(t,void 0,h.extend({},e,{unset:true}))},clear:function(t){var e={};for(var i in this.attributes)e[i]=void 0;return this.set(e,h.extend({},t,{unset:true}))},hasChanged:function(t){if(t==null)return!h.isEmpty(this.changed);return h.has(this.changed,t)},changedAttributes:function(t){if(!t)return this.hasChanged()?h.clone(this.changed):false;var e,i=false;var s=this._changing?this._previousAttributes:this.attributes;for(var r in t){if(h.isEqual(s[r],e=t[r]))continue;(i||(i={}))[r]=e}return i},previous:function(t){if(t==null||!this._previousAttributes)return null;return this._previousAttributes[t]},previousAttributes:function(){return h.clone(this._previousAttributes)},fetch:function(t){t=t?h.clone(t):{};if(t.parse===void 0)t.parse=true;var e=t.success;t.success=function(t,i,s){if(!t.set(t.parse(i,s),s))return false;if(e)e(t,i,s)};return this.sync("read",this,t)},save:function(t,e,i){var s,r,n,a,o=this.attributes;if(t==null||typeof t==="object"){s=t;i=e}else{(s={})[t]=e}if(s&&(!i||!i.wait)&&!this.set(s,i))return false;i=h.extend({validate:true},i);if(!this._validate(s,i))return false;if(s&&i.wait){this.attributes=h.extend({},o,s)}if(i.parse===void 0)i.parse=true;r=i.success;i.success=function(t,e,i){t.attributes=o;var n=t.parse(e,i);if(i.wait)n=h.extend(s||{},n);if(h.isObject(n)&&!t.set(n,i)){return false}if(r)r(t,e,i)};n=this.isNew()?"create":i.patch?"patch":"update";if(n==="patch")i.attrs=s;a=this.sync(n,this,i);if(s&&i.wait)this.attributes=o;return a},destroy:function(t){t=t?h.clone(t):{};var e=this;var i=t.success;var s=function(){e.trigger("destroy",e,e.collection,t)};t.success=function(t,e,r){if(r.wait||t.isNew())s();if(i)i(t,e,r)};if(this.isNew()){t.success(this,null,t);return false}var r=this.sync("delete",this,t);if(!t.wait)s();return r},url:function(){var t=h.result(this,"urlRoot")||h.result(this.collection,"url")||N();if(this.isNew())return t;return t+(t.charAt(t.length-1)==="/"?"":"/")+encodeURIComponent(this.id)},parse:function(t,e){return t},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},isValid:function(t){return!this.validate||!this.validate(this.attributes,t)},_validate:function(t,e){if(!e.validate||!this.validate)return true;t=h.extend({},this.attributes,t);var i=this.validationError=this.validate(t,e)||null;if(!i)return true;this.trigger("invalid",this,i,e||{});return false}});var d=a.Collection=function(t,e){e||(e={});if(e.model)this.model=e.model;if(e.comparator!==void 0)this.comparator=e.comparator;this.models=[];this._reset();this.initialize.apply(this,arguments);if(t)this.reset(t,h.extend({silent:true},e))};h.extend(d.prototype,c,{model:f,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return a.sync.apply(this,arguments)},add:function(t,e){t=h.isArray(t)?t.slice():[t];e||(e={});var i,r,a,o,u,l,c,f,d,p;c=[];f=e.at;d=this.comparator&&f==null&&e.sort!=false;p=h.isString(this.comparator)?this.comparator:null;for(i=0,r=t.length;i<r;i++){if(!(a=this._prepareModel(o=t[i],e))){this.trigger("invalid",this,o,e);continue}if(u=this.get(a)){if(e.merge){u.set(o===a?a.attributes:o,e);if(d&&!l&&u.hasChanged(p))l=true}continue}c.push(a);a.on("all",this._onModelEvent,this);this._byId[a.cid]=a;if(a.id!=null)this._byId[a.id]=a}if(c.length){if(d)l=true;this.length+=c.length;if(f!=null){n.apply(this.models,[f,0].concat(c))}else{s.apply(this.models,c)}}if(l)this.sort({silent:true});if(e.silent)return this;for(i=0,r=c.length;i<r;i++){(a=c[i]).trigger("add",a,this,e)}if(l)this.trigger("sort",this,e);return this},remove:function(t,e){t=h.isArray(t)?t.slice():[t];e||(e={});var i,s,r,n;for(i=0,s=t.length;i<s;i++){n=this.get(t[i]);if(!n)continue;delete this._byId[n.id];delete this._byId[n.cid];r=this.indexOf(n);this.models.splice(r,1);this.length--;if(!e.silent){e.index=r;n.trigger("remove",n,this,e)}this._removeReference(n)}return this},push:function(t,e){t=this._prepareModel(t,e);this.add(t,h.extend({at:this.length},e));return t},pop:function(t){var e=this.at(this.length-1);this.remove(e,t);return e},unshift:function(t,e){t=this._prepareModel(t,e);this.add(t,h.extend({at:0},e));return t},shift:function(t){var e=this.at(0);this.remove(e,t);return e},slice:function(t,e){return this.models.slice(t,e)},get:function(t){if(t==null)return void 0;this._idAttr||(this._idAttr=this.model.prototype.idAttribute);return this._byId[t.id||t.cid||t[this._idAttr]||t]},at:function(t){return this.models[t]},where:function(t){if(h.isEmpty(t))return[];return this.filter(function(e){for(var i in t){if(t[i]!==e.get(i))return false}return true})},sort:function(t){if(!this.comparator){throw new Error("Cannot sort a set without a comparator")}t||(t={});if(h.isString(this.comparator)||this.comparator.length===1){this.models=this.sortBy(this.comparator,this)}else{this.models.sort(h.bind(this.comparator,this))}if(!t.silent)this.trigger("sort",this,t);return this},pluck:function(t){return h.invoke(this.models,"get",t)},update:function(t,e){e=h.extend({add:true,merge:true,remove:true},e);if(e.parse)t=this.parse(t,e);var i,s,r,n;var a=[],o=[],u={};if(!h.isArray(t))t=t?[t]:[];if(e.add&&!e.remove)return this.add(t,e);for(s=0,r=t.length;s<r;s++){i=t[s];n=this.get(i);if(e.remove&&n)u[n.cid]=true;if(e.add&&!n||e.merge&&n){a.push(i)}}if(e.remove){for(s=0,r=this.models.length;s<r;s++){i=this.models[s];if(!u[i.cid])o.push(i)}}if(o.length)this.remove(o,e);if(a.length)this.add(a,e);return this},reset:function(t,e){e||(e={});if(e.parse)t=this.parse(t,e);for(var i=0,s=this.models.length;i<s;i++){this._removeReference(this.models[i])}e.previousModels=this.models.slice();this._reset();if(t)this.add(t,h.extend({silent:true},e));if(!e.silent)this.trigger("reset",this,e);return this},fetch:function(t){t=t?h.clone(t):{};if(t.parse===void 0)t.parse=true;var e=t.success;t.success=function(t,i,s){var r=s.update?"update":"reset";t[r](i,s);if(e)e(t,i,s)};return this.sync("read",this,t)},create:function(t,e){e=e?h.clone(e):{};if(!(t=this._prepareModel(t,e)))return false;if(!e.wait)this.add(t,e);var i=this;var s=e.success;e.success=function(t,e,r){if(r.wait)i.add(t,r);if(s)s(t,e,r)};t.save(null,e);return t},parse:function(t,e){return t},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0;this.models.length=0;this._byId={}},_prepareModel:function(t,e){if(t instanceof f){if(!t.collection)t.collection=this;return t}e||(e={});e.collection=this;var i=new this.model(t,e);if(!i._validate(t,e))return false;return i},_removeReference:function(t){if(this===t.collection)delete t.collection;t.off("all",this._onModelEvent,this)},_onModelEvent:function(t,e,i,s){if((t==="add"||t==="remove")&&i!==this)return;if(t==="destroy")this.remove(e,s);if(e&&t==="change:"+e.idAttribute){delete this._byId[e.previous(e.idAttribute)];if(e.id!=null)this._byId[e.id]=e}this.trigger.apply(this,arguments)},sortedIndex:function(t,e,i){e||(e=this.comparator);var s=h.isFunction(e)?e:function(t){return t.get(e)};return h.sortedIndex(this.models,t,s,i)}});var p=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"];h.each(p,function(t){d.prototype[t]=function(){var e=r.call(arguments);e.unshift(this.models);return h[t].apply(h,e)}});var g=["groupBy","countBy","sortBy"];h.each(g,function(t){d.prototype[t]=function(e,i){var s=h.isFunction(e)?e:function(t){return t.get(e)};return h[t](this.models,s,i)}});var v=a.Router=function(t){t||(t={});if(t.routes)this.routes=t.routes;this._bindRoutes();this.initialize.apply(this,arguments)};var m=/\((.*?)\)/g;var y=/(\(\?)?:\w+/g;var _=/\*\w+/g;var b=/[\-{}\[\]+?.,\\\^$|#\s]/g;h.extend(v.prototype,c,{initialize:function(){},route:function(t,e,i){if(!h.isRegExp(t))t=this._routeToRegExp(t);if(!i)i=this[e];a.history.route(t,h.bind(function(s){var r=this._extractParameters(t,s);i&&i.apply(this,r);this.trigger.apply(this,["route:"+e].concat(r));this.trigger("route",e,r);a.history.trigger("route",this,e,r)},this));return this},navigate:function(t,e){a.history.navigate(t,e);return this},_bindRoutes:function(){if(!this.routes)return;var t,e=h.keys(this.routes);while((t=e.pop())!=null){this.route(t,this.routes[t])}},_routeToRegExp:function(t){t=t.replace(b,"\\$&").replace(m,"(?:$1)?").replace(y,function(t,e){return e?t:"([^/]+)"}).replace(_,"(.*?)");return new RegExp("^"+t+"$")},_extractParameters:function(t,e){return t.exec(e).slice(1)}});var w=a.History=function(){this.handlers=[];h.bindAll(this,"checkUrl");if(typeof window!=="undefined"){this.location=window.location;this.history=window.history}};var x=/^[#\/]|\s+$/g;var E=/^\/+|\/+$/g;var S=/msie [\w.]+/;var k=/\/$/;w.started=false;h.extend(w.prototype,c,{interval:50,getHash:function(t){var e=(t||this).location.href.match(/#(.*)$/);return e?e[1]:""},getFragment:function(t,e){if(t==null){if(this._hasPushState||!this._wantsHashChange||e){t=this.location.pathname;var i=this.root.replace(k,"");if(!t.indexOf(i))t=t.substr(i.length)}else{t=this.getHash()}}return t.replace(x,"")},start:function(t){if(w.started)throw new Error("Backbone.history has already been started");w.started=true;this.options=h.extend({},{root:"/"},this.options,t);this.root=this.options.root;this._wantsHashChange=this.options.hashChange!==false;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var e=this.getFragment();var i=document.documentMode;var s=S.exec(navigator.userAgent.toLowerCase())&&(!i||i<=7);this.root=("/"+this.root+"/").replace(E,"/");if(s&&this._wantsHashChange){this.iframe=a.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow;this.navigate(e)}if(this._hasPushState){a.$(window).on("popstate",this.checkUrl)}else if(this._wantsHashChange&&"onhashchange"in window&&!s){a.$(window).on("hashchange",this.checkUrl)}else if(this._wantsHashChange){this._checkUrlInterval=setInterval(this.checkUrl,this.interval)}this.fragment=e;var r=this.location;var n=r.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!n){this.fragment=this.getFragment(null,true);this.location.replace(this.root+this.location.search+"#"+this.fragment);return true}else if(this._wantsPushState&&this._hasPushState&&n&&r.hash){this.fragment=this.getHash().replace(x,"");this.history.replaceState({},document.title,this.root+this.fragment+r.search)}if(!this.options.silent)return this.loadUrl()},stop:function(){a.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl);clearInterval(this._checkUrlInterval);w.started=false},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(t){var e=this.getFragment();if(e===this.fragment&&this.iframe){e=this.getFragment(this.getHash(this.iframe))}if(e===this.fragment)return false;if(this.iframe)this.navigate(e);this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(t){var e=this.fragment=this.getFragment(t);var i=h.any(this.handlers,function(t){if(t.route.test(e)){t.callback(e);return true}});return i},navigate:function(t,e){if(!w.started)return false;if(!e||e===true)e={trigger:e};t=this.getFragment(t||"");if(this.fragment===t)return;this.fragment=t;var i=this.root+t;if(this._hasPushState){this.history[e.replace?"replaceState":"pushState"]({},document.title,i)}else if(this._wantsHashChange){this._updateHash(this.location,t,e.replace);if(this.iframe&&t!==this.getFragment(this.getHash(this.iframe))){if(!e.replace)this.iframe.document.open().close();this._updateHash(this.iframe.location,t,e.replace)}}else{return this.location.assign(i)}if(e.trigger)this.loadUrl(t)},_updateHash:function(t,e,i){if(i){var s=t.href.replace(/(javascript:|#).*$/,"");t.replace(s+"#"+e)}else{t.hash="#"+e}}});a.history=new w;var $=a.View=function(t){this.cid=h.uniqueId("view");this._configure(t||{});this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents()};var A=/^(\S+)\s*(.*)$/;var T=["model","collection","el","id","attributes","className","tagName","events"];h.extend($.prototype,c,{tagName:"div",$:function(t){return this.$el.find(t)},initialize:function(){},render:function(){return this},remove:function(){this.$el.remove();this.stopListening();return this},setElement:function(t,e){if(this.$el)this.undelegateEvents();this.$el=t instanceof a.$?t:a.$(t);this.el=this.$el[0];if(e!==false)this.delegateEvents();return this},delegateEvents:function(t){if(!(t||(t=h.result(this,"events"))))return;this.undelegateEvents();for(var e in t){var i=t[e];if(!h.isFunction(i))i=this[t[e]];if(!i)throw new Error('Method "'+t[e]+'" does not exist');var s=e.match(A);var r=s[1],n=s[2];i=h.bind(i,this);r+=".delegateEvents"+this.cid;if(n===""){this.$el.on(r,i)}else{this.$el.on(r,n,i)}}},undelegateEvents:function(){this.$el.off(".delegateEvents"+this.cid)},_configure:function(t){if(this.options)t=h.extend({},h.result(this,"options"),t);h.extend(this,h.pick(t,T));this.options=t},_ensureElement:function(){if(!this.el){var t=h.extend({},h.result(this,"attributes"));if(this.id)t.id=h.result(this,"id");if(this.className)t["class"]=h.result(this,"className");var e=a.$("<"+h.result(this,"tagName")+">").attr(t);this.setElement(e,false)}else{this.setElement(h.result(this,"el"),false)}}});var H={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};a.sync=function(t,e,i){var s=H[t];h.defaults(i||(i={}),{emulateHTTP:a.emulateHTTP,emulateJSON:a.emulateJSON});var r={type:s,dataType:"json"};if(!i.url){r.url=h.result(e,"url")||N()}if(i.data==null&&e&&(t==="create"||t==="update"||t==="patch")){r.contentType="application/json";r.data=JSON.stringify(i.attrs||e.toJSON(i))}if(i.emulateJSON){r.contentType="application/x-www-form-urlencoded";r.data=r.data?{model:r.data}:{}}if(i.emulateHTTP&&(s==="PUT"||s==="DELETE"||s==="PATCH")){r.type="POST";if(i.emulateJSON)r.data._method=s;var n=i.beforeSend;i.beforeSend=function(t){t.setRequestHeader("X-HTTP-Method-Override",s);if(n)return n.apply(this,arguments)}}if(r.type!=="GET"&&!i.emulateJSON){r.processData=false}var o=i.success;i.success=function(t){if(o)o(e,t,i);e.trigger("sync",e,t,i)};var u=i.error;i.error=function(t){if(u)u(e,t,i);e.trigger("error",e,t,i)};var l=i.xhr=a.ajax(h.extend(r,i));e.trigger("request",e,l,i);return l};a.ajax=function(){return a.$.ajax.apply(a.$,arguments)};var I=function(t,e){var i=this;var s;if(t&&h.has(t,"constructor")){s=t.constructor}else{s=function(){return i.apply(this,arguments)}}h.extend(s,i,e);var r=function(){this.constructor=s};r.prototype=i.prototype;s.prototype=new r;if(t)h.extend(s.prototype,t);s.__super__=i.prototype;return s};f.extend=d.extend=v.extend=$.extend=w.extend=I;var N=function(){throw new Error('A "url" property or function must be specified')}}).call(this);
var app=app||{};app.Delivery=Backbone.Model.extend({defaults:{way:"",time:""},initialize:function(){console.log("A delivery model has been created!")}});app.Extra=Backbone.Model.extend({defaults:{transfee:"",discounts:""},initialize:function(){console.log("An extra model has been created!")}});app.Item=Backbone.Model.extend({defaults:{id:"",cookbook:"",material:"",count:0,total:0},initialize:function(){this.set("id",this.get("Material").id);this.on("invalid",function(t,e){console.log(e)})},validate:function(t){}});app.Order=Backbone.Model.extend({defaults:{id:"",time:"",count:0,total:0,item_count:0,item_total:0,tuan_count:0,tuan_total:0,items:null,tuans:null},initialize:function(){var t=this;var e=new app.ItemCollection;var n=new app.ItemCollection;this.set("items",e);this.set("tuans",n);this.on("invalid",function(t,e){console.log(e)});this.get("items").on("add",function(e){e.set("count",1);e.set("total",parseInt(e.get("Material").price));t.set("item_count",t.get("item_count")+e.get("count"));t.set("item_total",t.get("item_total")+e.get("count")*parseInt(e.get("Material").price));t.set("count",t.get("item_count")+t.get("tuan_count"));t.set("total",t.get("item_total")+t.get("tuan_total"))});this.get("items").on("remove",function(e){t.set("item_count",t.get("item_count")-e.get("count"));t.set("item_total",t.get("item_total")-e.get("count")*parseInt(e.get("Material").price));t.set("count",t.get("item_count")+t.get("tuan_count"));t.set("total",t.get("item_total")+t.get("tuan_total"))});this.get("tuans").on("add",function(e){e.set("count",1);e.set("total",parseInt(e.get("Tutetuan").price));t.set("tuan_count",t.get("tuan_count")+e.get("count"));t.set("tuan_total",t.get("tuan_total")+e.get("count")*parseInt(e.get("Tutetuan").price));t.set("count",t.get("item_count")+t.get("tuan_count"));t.set("total",t.get("item_total")+t.get("tuan_total"))});this.get("tuans").on("remove",function(e){t.set("tuan_count",t.get("tuan_count")-e.get("count"));t.set("tuan_total",t.get("tuan_total")-e.get("count")*parseInt(e.get("Tutetuan").price));t.set("count",t.get("item_count")+t.get("tuan_count"));t.set("total",t.get("item_total")+t.get("tuan_total"))});this.on("change:item_count",function(){t.set("count",t.get("item_count")+t.get("tuan_count"))});this.on("change:item_total",function(){t.set("total",t.get("item_total")+t.get("tuan_total"));$(".items-total-price").html(t.get("item_total"))});this.on("change:tuan_count",function(){t.set("count",t.get("item_count")+t.get("tuan_count"))});this.on("change:tuan_total",function(){t.set("total",t.get("item_total")+t.get("tuan_total"));$(".tuans-total-price").html(t.get("tuan_total"))});this.on("change:count",function(e){$(".total-amount").each(function(){$(this).html(t.get("count"))});if(e.get("count")<=0){app.shoppingCartV.$el.hide()}else{app.shoppingCartV.$el.show()}});this.on("change:total",function(){$(".total-price").each(function(){$(this).html(t.get("total"))})})},validate:function(t){if(typeof t.count!=="number"){return"count must be a number"}else if(typeof t.count==="number"&&t.count<0){return"count can not be less than zero"}}});app.Payment=Backbone.Model.extend({defaults:{online:{name:"online",label:"在线支付",status:false},cool:{name:"cool",label:"货到付款",status:false}},initialize:function(){}});app.Tuan=Backbone.Model.extend({defaults:{Tutetuan:"",count:0,total:0},initialize:function(){this.set("id",this.get("Tutetuan").id);this.on("invalid",function(t,e){console.log(e)})},validate:function(t){}});app.User=Backbone.Model.extend({defaults:{wechatId:"",name:"",address:"",phone:"",remark:""},initialize:function(){this.on("invalid",function(t,e){console.log(e)})},validate:function(t){}});app.ItemCollection=Backbone.Collection.extend({model:app.Item});
var app=app||{};app.ItemView=Backbone.View.extend({className:"item",template:_.template($("#item-template").html()),events:{"click .item-image":"select","click .select-shadow":"unselect","click .single-item-info":"showDetail"},render:function(){this.$el.html(this.template(this.model.toJSON()));this.$el.attr("id","item-"+this.model.get("Cookbook").id);return this},select:function(){this.$el.find(".select-shadow").css("display","block");if($(".shopping-cart").css("display")==="none"){$(".shopping-cart").css("display","block")}app.shoppingCart.get("items").add(this.model);app.shoppingCart.get("items").date=this.model.get("date")},unselect:function(){this.$el.find(".select-shadow").css("display","none");app.shoppingCart.get("items").remove(this.model);if(app.shoppingCart.get("items").length==0&&app.shoppingCart.get("tuans").length==0){$(".shopping-cart").css("display","none")}},imgLazyLoad:function(){var e=this.$el.find(".item-image > img");var t=e.attr("lazy-src");var a=this.model.get("Cookbook").priority;if(t!==undefined){var i=new Image;i.onload=function(){e.attr("src",t);e.css({width:"100%",height:"110px","margin-top":"0"});if(a=="1"||a=="2"){e.css("height","180px")}};i.src=t}},showDetail:function(){var e=this;$.ajax({url:$("base").attr("src")+"items/"+this.model.get("Cookbook").id+".json",success:function(t){var a=new app.Item(t.rt_obj.data);$(".container").css("display","none");var i=new app.ItemDetailView({model:a,parent:e})},error:function(e){console.log(e)}})}});app.ItemViewWithoutImg=Backbone.View.extend({className:"item",template:_.template($("#item-template-no-img").html()),events:{"click .item-image":"select","click .select-shadow-no-img":"unselect","click .single-item-info":"showDetail"},render:function(){this.$el.html(this.template(this.model.toJSON()));this.$el.attr("id","item-"+this.model.get("Cookbook").id);this.imgLazyLoad();return this},select:function(){this.$el.find(".select-shadow-no-img").css("display","block");if($(".shopping-cart").css("display")==="none"){$(".shopping-cart").css("display","block")}app.shoppingCart.get("items").add(this.model)},unselect:function(){this.$el.find(".select-shadow-no-img").css("display","none");app.shoppingCart.get("items").remove(this.model);if(app.shoppingCart.get("items").length==0){$(".shopping-cart").css("display","none")}},imgLazyLoad:function(){var e=this.$el.find(".item-image > img");var t=e.attr("lazy-src");var a=this.model.get("Cookbook").priority;if(t!==undefined){var i=new Image;i.onload=function(){e.attr("src",t);e.css({width:"100%",height:"110px","margin-top":"0"});if(a=="1"||a=="2"){e.css("height","180px")}};i.src=t}},showDetail:function(){var e=this;$.ajax({url:$("base").attr("src")+"items/"+this.model.get("Cookbook").id+".json",success:function(t){var a=new app.Item(t.rt_obj.data);$(".container").css("display","none");var i=new app.ItemDetailView({model:a,parent:e})},error:function(e){console.log(e)}})}});app.TuanView=Backbone.View.extend({className:"tuan",template:_.template($("#tuan-template").html()),events:{"click .tuan-image":"select","click .select-shadow":"unselect","click .single-tuan-info":"showDetail"},render:function(){this.$el.html(this.template(this.model.toJSON()));this.$el.attr("id","tuan-"+this.model.get("Tutetuan").id);this.imgLazyLoad();return this},select:function(){this.$el.find(".select-shadow").css("display","block");if($(".shopping-cart").css("display")==="none"){$(".shopping-cart").css("display","block")}app.shoppingCart.get("tuans").add(this.model)},unselect:function(){this.$el.find(".select-shadow").css("display","none");app.shoppingCart.get("tuans").remove(this.model);if(app.shoppingCart.get("items").length==0&&app.shoppingCart.get("tuans").length==0){$(".shopping-cart").css("display","none")}},imgLazyLoad:function(){var e=this.$el.find(".tuan-image > img");var t=e.attr("lazy-src");if(t!==undefined){var a=new Image;a.onload=function(){e.attr("src",t);e.css({width:"100%",height:"180px","margin-top":"0"})};a.src=t}},showDetail:function(){var e=this;$.ajax({url:$("base").attr("src")+"tuans/"+this.model.get("Tutetuan").id+".json",success:function(t){var a=new app.Tuan(t.rt_obj.data);$(".container").css("display","none");var i=new app.TuanDetailView({model:a,parent:e})},error:function(e){console.log(e)}})}});app.TuanViewWithoutImg=Backbone.View.extend({className:"tuan",template:_.template($("#tuan-template-no-img").html()),events:{"click .tuan-image":"select","click .select-shadow-no-img":"unselect","click .single-tuan-info":"showDetail"},render:function(){this.$el.html(this.template(this.model.toJSON()));this.$el.attr("id","tuan-"+this.model.get("Tutetuan").id);this.imgLazyLoad();return this},select:function(){this.$el.find(".select-shadow-no-img").css("display","block");if($(".shopping-cart").css("display")==="none"){$(".shopping-cart").css("display","block")}app.shoppingCart.get("tuans").add(this.model)},unselect:function(){this.$el.find(".select-shadow-no-img").css("display","none");app.shoppingCart.get("tuans").remove(this.model);if(app.shoppingCart.get("tuans").length==0){$(".shopping-cart").css("display","none")}},imgLazyLoad:function(){var e=this.$el.find(".tuan-image > img");var t=e.attr("lazy-src");if(t!==undefined){var a=new Image;a.onload=function(){e.attr("src",t);e.css({width:"100%",height:"180px","margin-top":"0"})};a.src=t}},showDetail:function(){var e=this;$.ajax({url:$("base").attr("src")+"tuans/"+this.model.get("Tutetuan").id+".json",success:function(t){console.log(t);var a=new app.Tuan(t.rt_obj.data);$(".container").css("display","none");var i=new app.TuanDetailView({model:a,parent:e})},error:function(e){console.log(e)}})}});app.LoginView=Backbone.View.extend({className:"container",id:"login-container",template:_.template($("#loginView-template").html()),events:{"click #login":"login","click #forget":"getPassword","click #signin":"signIn","click .back":"back"},initialize:function(e){if(e&&e.backTo){this.backTo=e.backTo}$(".main-container").append(this.render().el)},render:function(){this.$el.html(this.template());return this},login:function(){var that=this;$(".login-tips").hide();$.ajax({url:$("base").attr("src")+"home/login/"+that.getUuid(),type:"post",data:{username:$("input[name=account]").val(),password:$("input[name=password]").val()},success:function(data){var rt_obj=eval("("+data+")");if(rt_obj.code==0){setCookie("wechat_id",current_user,100);that.$el.remove();$("#"+that.backTo).show()}else if(rt_obj.code==2){if(that.$el.find(".warning").length>0){}else{that.$el.find(".login-header").after('<p class="warning">^_^用户名或密码错误，请重新输入</p>')}}},error:function(e){console.log("login failed")}})},getPassword:function(){this.$el.hide();var e=new app.ForgetView;$(".main-container").append(e.render().el)},signIn:function(){},back:function(){var e=this;e.$el.remove();$("#"+e.backTo).show()},getUuid:function(){return function(){var e=window.location.search;var t=e.substr(1,e.length).split("&");for(var a=0;a<t.length;a++){var i=t[a].split("=");if(i[0]=="code"){return unescape(i[1])}}}()}});app.RegisterView=Backbone.View.extend({className:"container",id:"register-container",template:_.template($("#registerView-template").html()),events:{"click #register":"register","click .back":"back"},initialize:function(e){if(e&&e.backTo){this.backTo=e.backTo}$(".main-container").append(this.render().el)},render:function(){this.$el.html(this.template());return this},register:function(){var that=this;if(that.inputValidate()){console.log("validate success");$.ajax({url:$("base").attr("src")+"home/register/"+that.getUuid(),type:"post",data:{username:that.$el.find("input[name=account]").val(),password:that.$el.find("input[name=password]").val(),email:that.$el.find("input[name=email]").val()},success:function(data){var data=eval("("+data+")");if(data.code==0){var popupView=new app.OrderInfoPopupView({msg:"注册成功, 3秒后自动登录"});that.$el.append(popupView.render().el);setTimeout(function(){that.$el.remove();user_status="CUSTOMER";setCookie("wechat_id",current_user,100);$("#"+that.backTo).show()},3e3)}else if(data.code==1){var popupView=new app.OrderInfoPopupView({msg:data.msg});that.$el.append(popupView.render().el)}else if(data.code==2){var popupView=new app.OrderInfoPopupView({msg:data.msg});that.$el.append(popupView.render().el)}},error:function(){console.log("ajax error")}})}},back:function(){var e=this;e.$el.remove();$("#"+e.backTo).show()},inputValidate:function(){var e=this;var t=e.$el.find("input[name=account]").val(),a=e.$el.find("input[name=password]").val(),i=e.$el.find("input[name=repassword]").val(),n=e.$el.find("input[name=email]").val();var s=/^(\w){6,20}$/,r=/^(\w)+(\.\w+)*@(\w)+((\.\w+)+)$/;if(t==""){var o=new app.OrderInfoPopupView({msg:"用户名不能为空"});e.$el.append(o.render().el);return false}else if(!s.exec(a)){var o=new app.OrderInfoPopupView({msg:"密码长度不符合要求（6-20位）"});e.$el.append(o.render().el);return false}else if(a!==i){var o=new app.OrderInfoPopupView({msg:"两次输入的密码不一致"});e.$el.append(o.render().el);return false}else if(!r.exec(n)){var o=new app.OrderInfoPopupView({msg:"邮箱地址不正确"});e.$el.append(o.render().el);return false}else if(s.exec(a)&&r.exec(n)&&a===i){return true}return false},getUuid:function(){return function(){var e=window.location.search;var t=e.substr(1,e.length).split("&");for(var a=0;a<t.length;a++){var i=t[a].split("=");if(i[0]=="code"){return unescape(i[1])}}}()}});app.ForgetView=Backbone.View.extend({className:"container",id:"forget-container",template:_.template($("#forgetPasswordView-template").html()),events:{"click #getPassword":"submit","click .back":"back"},initialize:function(){$(".main-container").append(this.render().el)},render:function(){this.$el.html(this.template());return this},submit:function(){var that=this;$.ajax({url:$("base").attr("src")+"home/forget/"+that.getUuid(),type:"post",data:{username:$("#forget-container input[name=account]").val(),email:$("#forget-container input[name=email]").val()},success:function(data){var dataObj=eval("("+data+")");var popupView=new app.OrderInfoPopupView({msg:dataObj.message});that.$el.append(popupView.render().el)},error:function(e){console.log(e);console.log("login failed")}})},back:function(){this.$el.remove();$("#login-container").show()},getUuid:function(){return function(){var e=window.location.search;var t=e.substr(1,e.length).split("&");for(var a=0;a<t.length;a++){var i=t[a].split("=");if(i[0]=="code"){return unescape(i[1])}}}()}});app.ItemDetailView=Backbone.View.extend({className:"container",id:"itemsdetail-container",template:_.template($("#itemDetailView-template").html()),events:{"click .back":"back","click .addItem":"add"},initialize:function(e){this.parent=e.parent;$(window).scrollTop(0);$(".main-container").append(this.render().el);sc.dropdown("itemsdetail-container",".user");this.$el.append(new app.ShoppingCartView({model:app.shoppingCart}).render().el);if(app.shoppingCart.get("count")>0){if(this.$el.find(".shopping-cart").css("display")==="none"){this.$el.find(".shopping-cart").css("display","block")}}},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},add:function(){if(app.shoppingCart.get("items").get(this.model.get("Material").id)){var e=new app.OrderInfoPopupView({msg:"已加入购物车，请前往购物车查看"});this.$el.append(e.render().el)}else{this.parent.select()}},back:function(){this.$el.remove();$("#menu-container").css("display","block")}});app.TuanDetailView=Backbone.View.extend({className:"container",id:"tuansdetail-container",template:_.template($("#tuanDetailView-template").html()),events:{"click .back":"back","click .addItem":"add"},initialize:function(e){this.parent=e.parent;$(window).scrollTop(0);this.model.set("date",t(this.model));$(".main-container").append(this.render().el);sc.dropdown("tuansdetail-container",".user");this.$el.append(new app.ShoppingCartView({model:app.shoppingCart}).render().el);if(app.shoppingCart.count>0){if(this.$el.find(".shopping-cart").css("display")==="none"){this.$el.find(".shopping-cart").css("display","block")}}function t(e){var t;var a=["零","一","二","三","四","五","六","日"];t=new Date(parseInt(e.get("Tutetuan").time)*1e3);var i=t.getMonth()+1,n=t.getDate(),s=t.getDay();return i+"月"+n+"日周"+a[s]}},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},add:function(){if(app.shoppingCart.get("tuans").get(this.model.get("Tutetuan").id)){}else{this.parent.select()}},back:function(){this.$el.css("display","none");$("#menu-container").css("display","block")}});app.ItemListView=Backbone.View.extend({className:"items",hasPic:false,viewCollection:null,initialize:function(e){this.count=0;this.hasPic=e.hasPic;this.viewCollection=new Array;$(".main").append(this.render().el);this.scrollToLoad()},render:function(){var e=this;var t=this.model.length;var a=this.model.models;for(var i=0;i<t;i++){if(e.hasPic){var n=new app.ItemView({model:a[i]});var s=$(n.render().el);if(a[i].get("Cookbook").priority=="1"||a[i].get("Cookbook").priority=="2"){s.addClass("large");s.find(".select-shadow").addClass("large")}e.viewCollection.push(n)}else{var n=new app.ItemViewWithoutImg({model:a[i]});var s=$(n.render().el);if(a[i].get("Cookbook").priority=="1"||a[i].get("Cookbook").priority=="2"){s.addClass("large");s.find(".select-shadow-no-img").addClass("large")}e.viewCollection.push(n)}e.$el.append(s)}return this},scrollToLoad:function(){var e=this;var t=$(window).height(),a=$("#menu-container").find(".header").height();marqueeHeight=$("#menu-container").find(".marquee").height();footerHeight=$("#menu-container").find(".toolbar").height();listInViewHeight=t-a-footerHeight;var i=0,n=0;var s=marqueeHeight;for(var r=0;r<this.viewCollection.length;r++){if(this.viewCollection[r].$el.hasClass("large")){i+=1}else{break}}while(true){if(i>0){s+=246+20;i--;n++}else{s+=200+20;n+=2}if(s>listInViewHeight){break}}for(var r=0;r<n;r++){this.viewCollection[r].imgLazyLoad()}$(window).scroll(function(){for(var t=n;t<e.viewCollection.length;t++){var a=e.viewCollection[t].$el.height();var i=1;if(a==200){i=2}if($(window).scrollTop()+listInViewHeight>=e.viewCollection[t].$el.offset().top+51){if(i==1){e.viewCollection[t].imgLazyLoad();n++}else if(i==2){e.viewCollection[t++].imgLazyLoad();n++;if(e.viewCollection[t]){e.viewCollection[t].imgLazyLoad();n++}}}}})}});app.TuanListView=Backbone.View.extend({className:"tuans",hasPic:false,initialize:function(e){this.count=0;this.hasPic=e.hasPic;$(".main").append(this.render().el)},render:function(){var e=this;var t=this.model.length;var a=this.model.models;var i=0;for(var n=0;n<t;n++){if(e.hasPic){var s=new app.TuanView({model:a[n]});var r=$(s.render().el);r.addClass("large");r.find(".select-shadow").addClass("large");e.$el.append(r)}else{var s=new app.TuanViewWithoutImg({model:a[n]});var r=$(s.render().el);r.addClass("large");r.find(".select-shadow-no-img").addClass("large");e.$el.append(r)}}return this}});app.ShoppingCartView=Backbone.View.extend({template:_.template($("#shoppingCart-template").html()),events:{click:"enterShoppingCart"},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},enterShoppingCart:function(){$(".container").css("display","none");var e=$("#order-container");if(e.length>0){e.remove();var e=new app.OrderView({model:this.model})}else{var e=new app.OrderView({model:this.model})}}});var app=app||{};app.MenuView=Backbone.View.extend({className:"container",id:"menu-container",template:_.template($("#menuView-template").html()),events:{"click #vegetable":"showVegetables","click #meat":"showMeat","click #soup":"showSoup","click #speciality":"showSpeciality"},hasPic:false,initialize:function(){$(".main-container").append(this.render().el);sc.dropdown("menu-container",".user");sc.togglePic(".togglePic")},render:function(){this.$el.html(this.template("this.model.toJSON()"));return this},setPic:function(e){this.hasPic=e},renderList:function(e){var t=items[e];if(t){var a=new app.ItemCollection;var i;for(var n=0;n<t.length;n++){if(e!=3){var s=new app.Item(t[n]);s.set("date",p(s,e));a.add(s)}else{var r=new app.Tuan(t[n]);r.set("date",p(r,e));a.add(r)}i="items-"+e}if(e==0||e==1||e==2){var o=new app.ItemListView({model:a,id:i,hasPic:this.hasPic})}else if(e==3){var l=new app.TuanListView({model:a,id:i,hasPic:this.hasPic})}}else{return}function p(e,t){var a;var i=["零","一","二","三","四","五","六","日"];if(t=="0"||t=="1"||t=="2"){a=new Date;var n=new Date(a.getTime()+864e5);var s=n.getMonth()+1,r=n.getDate(),o=n.getDay();return s+"月"+r+"日"}else if(t=="3"){a=new Date(parseInt(e.get("Tutetuan").time)*1e3);var s=a.getMonth()+1,r=a.getDate(),o=a.getDay();return s+"月"+r+"日"}}},handleJSON:function(e,t){if(e===undefined){var a=new app.ItemCollection;var i=new app.ItemListView({model:a});return}var n=new app.ItemCollection;var s;for(var r=0;r<e.length;r++){if(t=="0"){var o=new app.Item(e[r]);o.set("date",c(o,"0"));app.vegetableCollection.add(o);s="items-0";n=app.vegetableCollection}else if(t=="1"){var o=new app.Item(e[r]);o.set("date",c(o,"1"));app.meatCollection.add(o);s="items-1";n=app.meatCollection}else if(t=="2"){var o=new app.Item(e[r]);o.set("date",c(o,"2"));app.soupCollection.add(o);s="items-2";n=app.soupCollection}else if(t=="3"){var l=new app.Tuan(e[r]);l.set("date",c(l,"3"));app.specialityCollection.add(l);s="items-3";n=app.specialityCollection}}if(t=="0"||t=="1"||t=="2"){var p=new app.ItemListView({model:n,id:s,hasPic:this.hasPic})}else if(t=="3"){var d=new app.TuanListView({model:n,id:s,hasPic:this.hasPic})}function c(e,t){var a;var i=["零","一","二","三","四","五","六","日"];if(t=="0"||t=="1"||t=="2"){a=new Date;var n=new Date(a.getTime()+864e5);var s=n.getMonth()+1,r=n.getDate(),o=n.getDay();return s+"月"+r+"日"}else if(t=="3"){a=new Date(parseInt(e.get("Tutetuan").time)*1e3);var s=a.getMonth()+1,r=a.getDate(),o=a.getDay();return s+"月"+r+"日"}}},showVegetables:function(){$(".types ul li").removeClass("active");$("#vegetable").addClass("active");$(".items").hide();$(".tuans").hide();$(window).scrollTop(0);if($("#items-0").length>0){$("#items-0").show()}else{this.renderList(0)}},showMeat:function(){$(".types ul li").removeClass("active");$("#meat").addClass("active");$(".items").hide();$(".tuans").hide();$(window).scrollTop(0);if($("#items-1").length>0){$("#items-1").show()}else{this.renderList(1)}},showSoup:function(){$(".types ul li").removeClass("active");$("#soup").addClass("active");$(".items").hide();$(".tuans").hide();$(window).scrollTop(0);if($("#items-2").length>0){$("#items-2").show()}else{this.renderList(2)}},showSpeciality:function(){$(".types ul li").removeClass("active");$("#speciality").addClass("active");$(".items").hide();$(window).scrollTop(0);if($("#items-3").length>0){$("#items-3").show()}else{this.renderList(3)}}});app.OrderItemView=Backbone.View.extend({tagName:"li",template:_.template($("#orderItemView-template").html()),events:{"click .minus":"minus","click .add":"add","click .delete-btn":"removeItem"},initialize:function(){if(!this.model.get("count")){this.model.set("count",1);this.model.set("total",parseInt(this.model.get("Material").price))}},render:function(){this.$el.html(this.template(this.model.toJSON()));if(this.model.get("count")>1){this.$el.find(".minus").removeClass("disabled")}return this},minus:function(){var e=parseInt(this.$el.find(".amount").val());if(e>2){this.$el.find(".amount").val(e-1);this.$el.find(".minus").removeClass("disabled")}else if(e==2){this.$el.find(".amount").val(e-1);this.$el.find(".minus").addClass("disabled")}else{this.$el.find(".minus").addClass("disabled");return}this.model.set("count",e-1);this.model.set("total",this.model.get("total")-parseInt(this.model.get("Material").price));app.shoppingCart.set("item_count",app.shoppingCart.get("item_count")-1);app.shoppingCart.set("item_total",app.shoppingCart.get("item_total")-parseInt(this.model.get("Material").price));this.updateView(-1)},add:function(){var e=parseInt(this.$el.find(".amount").val());this.$el.find(".amount").val(e+1);if(e+1>0){this.$el.find(".minus").removeClass("disabled")}else{this.$el.find(".minus").addClass("disabled")}this.model.set("count",e+1);this.model.set("total",this.model.get("total")+parseInt(this.model.get("Material").price));app.shoppingCart.set("item_count",app.shoppingCart.get("item_count")+1);app.shoppingCart.set("item_total",app.shoppingCart.get("item_total")+parseInt(this.model.get("Material").price));this.updateView(1)},removeItem:function(){var e=this.model.get("Cookbook").id;if($("#item-"+e).find(".select-shadow").length>0){$("#item-"+e).find(".select-shadow").css("display","none")}if($("#item-"+e).find(".select-shadow-no-img").length>0){$("#item-"+e).find(".select-shadow-no-img").css("display","none")}app.shoppingCart.get("items").remove(this.model);this.remove();if(app.shoppingCart.get("count")==0){$("#order-container").hide();$("#menu-container").show()}},updateView:function(e){this.$el.find(".item-amount").html(this.model.get("count"));this.$el.find(".item-total-price").html("￥"+this.model.get("total"))}});app.OrderTuanView=Backbone.View.extend({tagName:"li",template:_.template($("#orderTuanView-template").html()),events:{"click .minus":"minus","click .add":"add","click .delete-btn":"removeItem"},initialize:function(){if(!this.model.get("count")){this.model.set("count",1);this.model.set("total",parseInt(this.model.get("Tutetuan").price))}},render:function(){this.$el.html(this.template(this.model.toJSON()));if(this.model.get("count")>1){this.$el.find(".minus").removeClass("disabled")}return this},minus:function(){var e=parseInt(this.$el.find(".amount").val());if(e>2){this.$el.find(".amount").val(e-1);this.$el.find(".minus").removeClass("disabled")}else if(e==2){this.$el.find(".amount").val(e-1);this.$el.find(".minus").addClass("disabled")}else{this.$el.find(".minus").addClass("disabled");return}this.model.set("count",e-1);this.model.set("total",this.model.get("total")-parseInt(this.model.get("Tutetuan").price));app.shoppingCart.set("tuan_count",app.shoppingCart.get("tuan_count")-1);app.shoppingCart.set("tuan_total",app.shoppingCart.get("tuan_total")-parseInt(this.model.get("Tutetuan").price));this.updateView(-1)},add:function(){var e=parseInt(this.$el.find(".amount").val());this.$el.find(".amount").val(e+1);if(e+1>0){this.$el.find(".minus").removeClass("disabled")}else{this.$el.find(".minus").addClass("disabled")}this.model.set("count",e+1);this.model.set("total",this.model.get("total")+parseInt(this.model.get("Tutetuan").price));app.shoppingCart.set("tuan_count",app.shoppingCart.get("tuan_count")+1);app.shoppingCart.set("tuan_total",app.shoppingCart.get("tuan_total")+parseInt(this.model.get("Tutetuan").price));this.updateView(1)},removeItem:function(){var e=this.model.get("Tutetuan").id;if($("#tuan-"+e).find(".select-shadow").length>0){$("#tuan-"+e).find(".select-shadow").css("display","none")}if($("#tuan-"+e).find(".select-shadow-no-img").length>0){$("#tuan-"+e).find(".select-shadow-no-img").css("display","none")}app.shoppingCart.get("tuans").remove(this.model);this.remove();if(app.shoppingCart.get("count")==0){$("#order-container").hide();$("#menu-container").show()}},updateView:function(e){this.$el.find(".tuan-amount").html(this.model.get("count"));this.$el.find(".tuan-total-price").html("￥"+this.model.get("total"))}});app.OrderView=Backbone.View.extend({className:"container",id:"order-container",template:_.template($("#orderView-template").html()),events:{"click .back":"back","click .next":"next"},initialize:function(){$(window).scrollTop(0);$(".main-container").append(this.render().el);sc.dropdown("order-container",".user")},render:function(){this.$el.html(this.template(this.model.toJSON()));var e=this;var t=this.model.get("items");t.forEach(function(t){var a=new app.OrderItemView({model:t});e.$el.find("#item-list").find("ul").append(a.render().el)});var a=this.model.get("tuans");a.forEach(function(t){var a=new app.OrderTuanView({model:t});e.$el.find("#tuan-list").find("ul").append(a.render().el)});if(t.length===0){this.$el.find("#item-list").css("display","none")}if(a.length===0){this.$el.find("#tuan-list").css("display","none")}return this},back:function(){this.$el.css("display","none");$("#menu-container").css("display","block")},next:function(){this.$el.css("display","none");var e=$("#delivery-container");if(e.length>0){e.css("display","block")}else{app.UserInfo=new app.User;var e=new app.DeliveryView({model:app.UserInfo})}}});app.OrderInfoPopupView=Backbone.View.extend({className:"popup",id:"orderInfo-popup",template:_.template($("#orderInfoPopupView-template").html()),events:{"click button":"close"},initialize:function(e){this.msg=e.msg},render:function(){this.$el.html(this.template());this.$el.find(".popup-header").append(this.msg);var e=this;setTimeout(function(){e.close()},2e3);return this},close:function(){this.$el.remove()}});app.OrderConfirmPopupView=Backbone.View.extend({className:"popup",id:"orderConfirm-popup",template:_.template($("#orderConfirmPopupView-template").html()),events:{"click #yes":"submit","click #no":"close"},initialize:function(e,t){if(e!=undefined){if(e.msg)this.msg=e.msg;if(e.tips)this.tips=e.tips;if(e.yesLabel)this.yesLabel=e.yesLabel;if(e.noLabel)this.noLabel=e.noLabel}if(t!=undefined){this.ajaxSetting=t}},render:function(){this.$el.html(this.template());if(this.msg)this.$el.find(".popup-header").append(this.msg);if(this.tips)this.$el.find(".popup-tips").append(this.tips);if(this.yesLabel)this.$el.find("#yes").html(this.yesLabel);if(this.noLabel)this.$el.find("#no").html(this.noLabel);return this},submit:function(){var e=this;$.ajax(e.ajaxSetting);this.$el.remove()},close:function(){this.$el.remove()}});app.PaymentView=Backbone.View.extend({className:"payment",template:_.template($("#paymentView-template").html()),events:{"click #online-payment":"selectOnline","click #cool-payment":"selectCool"},initialize:function(){},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},selectOnline:function(){var e=new app.OrderInfoPopupView({msg:"努力开发中，会在近期上线哦~ ^_^"});this.$el.append(e.render().el)},selectCool:function(){this.$el.find(".radio").removeClass("selected");this.$el.find("#cool-payment > .radio").addClass("selected")}});app.DeliveryView=Backbone.View.extend({className:"container",id:"delivery-container",template:_.template($("#deliveryView-template").html()),events:{"click .back":"back","click .next":"next"},initialize:function(){$(window).scrollTop(0);$(".main-container").append(this.render().el);var e=new app.Payment;var t=new app.PaymentView({model:e});this.$el.find(".confirmation-form").after(t.render().el);sc.dropdown("delivery-container",".user")},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},back:function(){this.$el.css("display","none");$("#order-container").css("display","block")},next:function(){var that=this;var pass=true;if(this.userInfoChanged){pass=this.updateUserInfo()}if(current_user===sc.getWechatId()){if(pass){var postData=this.extractData();$.ajax({url:$("base").attr("src")+"orders/add/"+(new Date).getTime(),type:"post",data:postData,success:function(data){var data=eval("("+data+")");that.$el.css("display","none");if(data.data.cart_id){app.shoppingCart.set("cart_id",data.data.cart_id)}else{app.shoppingCart.set("cart_id","")}if(data.data.tuan_id){app.shoppingCart.get("tuans").forEach(function(e){e.set("tuan_id",data.data.tuan_id)})}else{app.shoppingCart.get("tuans").forEach(function(e){e.set("tuan_id","")})}var orderResultView=new app.OrderResultView({model:app.shoppingCart})},error:function(e){console.log(e)}})}}else if(current_user&&user_status=="NEW_USER"){that.$el.hide();app.registerView=new app.RegisterView({backTo:"delivery-container"})}else if(current_user&&user_status=="CUSTOMER"){that.$el.hide();app.loginView=new app.LoginView({backTo:"delivery-container"})}else if(current_user==undefined){var pop=new app.OrderInfoPopupView({msg:"错误的用户，请重新关注小农女送菜^_^"});that.$el.append(pop.render().el)}},updateUserInfo:function(){var e=this;var t=/^1[3|4|5|8][0-9]{9}$/;var a=e.$el.find("input[name=tel]").val(),i=e.$el.find("input[name=username]").val(),n=e.$el.find("input[name=addr]").val();if(t.exec(a)&&i!=""&&n!=""){$.ajax({url:$("base").attr("src")+"customers/edit/"+this.getUuid(),type:"post",data:{Customer:{wechat_id:e.getWechatId(),name:e.$el.find("input[name=username]").val(),phone:e.$el.find("input[name=tel]").val(),location:e.$el.find("select[name=district]").val()+"-"+e.$el.find("input[name=addr]").val(),remark:e.$el.find("input[name=note]").val()}},success:function(t){e.userInfoChanged=true},error:function(){console.log("error")}});return true}else if(i==""){e.$el.find("input[name=username]").css("color","red");e.$el.find("input[name=username]").focus();e.$el.find("input[name=username]").bind("change",function(){$(this).css("color","black");$(this).unbind("change")});return false}else if(!t.exec(a)){e.$el.find("input[name=tel]").css("color","red");e.$el.find("input[name=tel]").focus();e.$el.find("input[name=tel]").bind("change",function(){$(this).css("color","black");$(this).unbind("change")});return false}else if(n==""){e.$el.find("input[name=addr]").css("color","red");e.$el.find("input[name=addr]").focus();e.$el.find("input[name=addr]").bind("change",function(){$(this).css("color","black");$(this).unbind("change")});return false}},getUuid:function(){return function(){var e=window.location.search;var t=e.substr(1,e.length).split("&");for(var a=0;a<t.length;a++){var i=t[a].split("=");if(i[0]=="code"){return unescape(i[1])}}}()},getWechatId:function(){return function(){var e=document.cookie.split("; ");for(var t=0;t<e.length;t++){var a=e[t].split("=");if(a[0]=="wechat_id")return unescape(a[1])}}()},userInfoChanged:function(){return true},extractData:function(){var e=app.shoppingCart;var t={Cart:[],Tuan:[]};e.get("items").forEach(function(e){var a={};a.cookbook_id=e.get("Cookbook").id;a.material_id=e.get("Material").id;a.count=e.get("count");t.Cart.push(a)});e.get("tuans").forEach(function(e){var a={};a.id=e.get("Tutetuan").id;a.count=e.get("count");t.Tuan.push(a)});return t}});app.OrderResultView=Backbone.View.extend({className:"container",id:"orderResult-container",template:_.template($("#orderResultView-template").html()),events:{"click .next":"nextOrder"},initialize:function(e){$(window).scrollTop(0);$(".main-container").append(this.render().el);sc.dropdown("orderResult-container",".user");var t=new Date;$(".date").html(t.getMonth()+1+"月"+t.getDate()+"日 "+t.getHours()+":"+t.getMinutes())},render:function(){this.$el.html(this.template(this.model.toJSON()));var e=this;var t=this.model.get("items");if(t.length>0){var a=new app.ItemsResultView({model:this.model});e.$el.find(".orderResultList-container").append(a.render().el);t.forEach(function(t){var a=new app.ResultItemView({model:t});e.$el.find("#item-order-list").find("ul").append(a.render().el)})}var i=this.model.get("tuans");if(i.length>0){i.forEach(function(t){var a=new app.TuansResultView({model:t});e.$el.find(".orderResultList-container").append(a.render().el);var i=new app.ResultTuanView({model:t});a.$el.find("#tuan-order-list").find("ul").append(i.render().el)})}if(t.length===0){this.$el.find("#items-order-result").css("display","none")}if(i.length===0){this.$el.find("#tuans-order-result").css("display","none")}return this},nextOrder:function(){window.location.reload()}});app.ItemsResultView=Backbone.View.extend({template:_.template($("#itemsResultView-template").html()),events:{"click .cancelOrder":"cancelOrder"},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},cancelOrder:function(){var that=this;var cart_id=this.model.get("cart_id");var confirm=new app.OrderConfirmPopupView({msg:"确定取消订单吗？"},{url:$("base").attr("src")+"orders/delete/"+cart_id,type:"post",success:function(data){console.log(data);var data=eval("("+data+")");if(data.code==1){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#orderResult-container").append(popup.render().el)}else{if(data.msg=="订单删除成功"){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#orderResult-container").append(popup.render().el);
that.$el.remove()}else{var popup=new app.OrderInfoPopupView({msg:data.msg});$("#orderResult-container").append(popup.render().el)}}},error:function(e){console.log(e)}});$("#orderResult-container").append(confirm.render().el)}});app.TuansResultView=Backbone.View.extend({template:_.template($("#tuansResultView-template").html()),events:{"click .cancelOrder":"cancelOrder"},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},cancelOrder:function(){var that=this;var tuan_id=this.model.get("tuan_id");var confirm=new app.OrderConfirmPopupView({msg:"确定取消订单吗？"},{url:$("base").attr("src")+"orders/delete/"+tuan_id,type:"post",success:function(data){console.log(data);var data=eval("("+data+")");if(data.code==1){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#orderResult-container").append(popup.render().el)}else{if(data.msg=="订单删除成功"){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#orderResult-container").append(popup.render().el);that.$el.remove()}else{var popup=new app.OrderInfoPopupView({msg:data.msg});$("#orderResult-container").append(popup.render().el)}}},error:function(e){console.log(e)}});$("#orderResult-container").append(confirm.render().el)}});app.ResultItemView=Backbone.View.extend({tagName:"li",template:_.template($("#resultItemView-template").html()),render:function(){this.$el.html(this.template(this.model.toJSON()));return this}});app.ResultTuanView=Backbone.View.extend({tagName:"li",template:_.template($("#resultTuanView-template").html()),render:function(){this.$el.html(this.template(this.model.toJSON()));return this}});app.MyOrdersView=Backbone.View.extend({className:"container",id:"myOrders-container",template:_.template($("#myOrdersView-template").html()),events:{"click .next":"next","click .history-loader":"loadHistory"},initialize:function(){$(window).scrollTop(0);var e=this;var t=new Date;this.cur_date=parseInt(t.getFullYear()+""+sc.normalizeNumber(t.getMonth()+1)+""+sc.normalizeNumber(t.getDate()));this.cur_time=t.getHours();$.ajax({url:$("base").attr("src")+"orders/"+this.cur_date+".json",success:function(t){e.rt_data=t.rt_obj.data;e.date=t.rt_obj.date;e.code=t.rt_obj.code;$(".main-container").append(e.render().el);sc.dropdown("myOrders-container",".user")},error:function(){console.log("error")}})},render:function(){this.$el.html(this.template());if(this.code!=2){this.parseOrder()}return this},next:function(){window.location.reload()},loadHistory:function(){var e=this;if(this.code!=2){$.ajax({url:$("base").attr("src")+"orders/"+e.date+".json",success:function(t){e.rt_data=t.rt_obj.data;e.date=t.rt_obj.date;e.code=t.rt_obj.code;if(e.code!=2){e.parseOrder()}},error:function(){console.log("error")}})}},parseOrder:function(){if(this.code!=1&&this.code!=2){if(this.rt_data.cart||this.rt_data.tuan){var e=new app.OneDayOrderView;this.$el.find(".myOrderList").append(e.render().el)}if(this.rt_data.cart){var t=new app.Order(this.rt_data.cart);var a=" 处理中";var i=this.getDateStr(this.date,2);if(this.cur_date>i){a=" 已配送"}else if(this.cur_date==i){if(this.cur_time<6){a=" 采购中"}else if(this.cur_time>=6&&this.cur_time<16){a=" 已采购"}else if(this.cur_time>=16&&this.cur_time<19){a=" 配送中"}else if(this.cur_time>=19){a=" 已配送"}}t.set("order_status",this.getDateStr(this.date,1)+a);t.set("cart_id",this.rt_data.cart_id);t.set("cart_total",this.rt_data.cart_total);var n=new app.ItemOrderView({model:t,status:a});e.$el.find(".orderResult-form").append(n.render().el);for(var s=0;s<this.rt_data.cart.length;s++){var r=new app.Item(this.rt_data.cart[s]);r.set("count",parseInt(r.get("Cart").count));r.set("total",r.get("count")*parseInt(r.get("Material").price));r.set("total",r.get("Material").price);var o=new app.ResultItemView({model:r});n.$el.find("ul").append(o.render().el)}}if(this.rt_data.tuan){var l=this.divideTuan(this.rt_data.tuan);for(var p in l){e.$el.find(".orderResult-form").append('<div class="dotted-divider"></div>');var a=" 处理中";var i=l[p][0].Tutetuan.deliver_date;if(this.cur_date>i){a=" 已配送"}else if(this.cur_date==i){if(this.cur_time<6){a=" 采购中"}else if(this.cur_time>=6&&this.cur_time<16){a=" 已采购"}else if(this.cur_time>=16&&this.cur_time<19){a=" 配送中"}else if(this.cur_time>=19){a=" 已配送"}}var t=new app.Order(this.rt_data.tuan);t.set("tuan_id",this.rt_data.tuan_id);t.set("order_status",this.getDateStr(this.date,1)+a);t.set("tuan_total",l[p].total);var d=new app.TuanOrderView({model:t,status:a});e.$el.find(".orderResult-form").append(d.render().el);for(var s=0;s<l[p].length;s++){var c=new app.Tuan(l[p][s]);c.set("count",parseInt(c.get("TutetuanCart").number));c.set("total",c.get("count")*parseInt(c.get("Tutetuan").price));c.set("total",c.get("Tutetuan").price);var u=new app.ResultTuanView({model:c});d.$el.find("ul").append(u.render().el)}}}}},getDateStr:function(e,t){e=""+e;var a=e.substr(0,4);var i=e.substr(4,2);var n=e.substr(6,2);var s=new Date(a,i,n);s.setDate(s.getDate()+t);var r=s.getFullYear();var o=s.getMonth();if(o<10){o="0"+o}var l=s.getDate();if(l<10){l="0"+l}return parseInt(r+""+o+""+l)},divideTuan:function(e){var t=new Array;var a={};for(var i=0;i<e.length;i++){if(t.indexOf(e[i].Tutetuan.id)==-1){t.push(e[i].Tutetuan.id);a["tuan_"+e[i].Tutetuan.id]=new Array;a["tuan_"+e[i].Tutetuan.id].total=0;a["tuan_"+e[i].Tutetuan.id].push(e[i])}else{a["tuan_"+e[i].Tutetuan.id].push(e[i])}a["tuan_"+e[i].Tutetuan.id].total+=parseInt(e[i].TutetuanCart.number)*parseInt(e[i].Tutetuan.price)}return a}});app.OneDayOrderView=Backbone.View.extend({template:_.template($("#oneDayOrderView-template").html()),render:function(){this.$el.html(this.template());return this}});app.ItemOrderView=Backbone.View.extend({template:_.template($("#itemOrderView-template").html()),events:{"click .cancelOrder":"cancelOrder"},initialize:function(e){if(e!=undefined){this.status=e.status}},render:function(){this.$el.html(this.template(this.model.toJSON()));if(this.status&&this.status.trim()=="已配送"){this.$el.find(".cancelOrder").remove()}return this},cancelOrder:function(){var that=this;var cart_id=this.model.get("cart_id");if(that.status.trim()=="处理中"||that.status.trim()=="采购中"){var confirm=new app.OrderConfirmPopupView({msg:"确定取消订单吗？"},{url:$("base").attr("src")+"orders/delete/"+cart_id,type:"post",success:function(data){var data=eval("("+data+")");if(data.code==1){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el)}else{if(data.msg=="订单删除成功"){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el);that.$el.remove()}else{var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el)}}},error:function(e){console.log(e)}});$("#myOrders-container").append(confirm.render().el)}else if(that.status.trim()=="已采购"){var confirm=new app.OrderConfirmPopupView({msg:"您的订单我们已采购",tips:"现在取消会造成我们的损失",yesLabel:"取消订单",noLabel:"保留订单"},{url:$("base").attr("src")+"orders/delete/"+cart_id,type:"post",success:function(data){var data=eval("("+data+")");if(data.code==1){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el)}else{if(data.msg=="订单删除成功"){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el);that.$el.remove()}else{var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el)}}},error:function(e){console.log(e)}});$("#myOrders-container").append(confirm.render().el)}else if(that.status.trim()=="配送中"){var popup=new app.OrderInfoPopupView({msg:"您的订单已经开始配送"});$("#myOrders-container").append(popup.render().el)}else if(that.status.trim()=="已配送"){var popup=new app.OrderInfoPopupView({msg:"订单已经配送成功，不能取消"});$("#myOrders-container").append(popup.render().el)}}});app.TuanOrderView=Backbone.View.extend({template:_.template($("#tuanOrderView-template").html()),events:{"click .cancelOrder":"cancelOrder"},initialize:function(e){if(e!=undefined){this.status=e.status}},render:function(){this.$el.html(this.template(this.model.toJSON()));if(this.status&&this.status.trim()=="已配送"){this.$el.find(".cancelOrder").remove()}return this},cancelOrder:function(){var that=this;var tuan_id=this.model.get("tuan_id");if(that.status.trim()=="采购中"||that.status.trim()=="处理中"){var confirm=new app.OrderConfirmPopupView({msg:"确定取消订单吗？"},{url:$("base").attr("src")+"orders/delete/"+tuan_id,type:"post",success:function(data){var data=eval("("+data+")");if(data.code==1){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el)}else{if(data.msg=="订单删除成功"){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el);that.$el.remove()}else{var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el)}}},error:function(e){console.log(e)}});$("#myOrders-container").append(confirm.render().el)}else if(that.status.trim()=="已采购"){var confirm=new app.OrderConfirmPopupView({msg:"您的订单我们已采购",tips:"现在取消会造成我们的损失",yesLabel:"取消订单",noLabel:"保留订单"},{url:$("base").attr("src")+"orders/delete/"+cart_id,type:"post",success:function(data){var data=eval("("+data+")");if(data.code==1){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el)}else{if(data.msg=="订单删除成功"){var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el);that.$el.remove()}else{var popup=new app.OrderInfoPopupView({msg:data.msg});$("#myOrders-container").append(popup.render().el)}}},error:function(e){console.log(e)}});$("#myOrders-container").append(confirm.render().el)}else if(that.status.trim()=="配送中"){var popup=new app.OrderInfoPopupView({msg:"您的订单已经开始配送"});$("#myOrders-container").append(popup.render().el)}else if(that.status.trim()=="已配送"){var popup=new app.OrderInfoPopupView({msg:"订单已经配送成功，不能取消"});$("#myOrders-container").append(popup.render().el)}}});

var sc=sc||{},app=app||{};(function(a){a.dropdown=function(a,b){$("#"+a).find(b).bind("click",function(){if("NEW_USER"==user_status){$(".container").hide();var a=new app.RegisterView({backTo:"menu-container"});$(".main-container").append(a.render().el)}else"block"==$("#menu-dropdown").css("display")?($("#menu-dropdown").hide(),$("#menu-shadow").hide()):($("#menu-dropdown").show(),$("#menu-shadow").show());"CUSTOMER"==user_status&&!sc.getWechatId()?$("#logout > a").text("\u767b\u5f55"):$("#logout > a").text("\u9000\u51fa\u767b\u5f55")})}})(sc);
(function(a){a.normalizeNumber=function(a){10>a&&(a="0"+a);return a}})(sc);(function(a){a.togglePic=function(a){$(a).bind("click",function(){setCookie("pic_status","no",100);window.location.reload()})}})(sc);(function(a){a.getWechatId=function(){for(var a=document.cookie.split("; "),b=0;b<a.length;b++){var c=a[b].split("=");if("wechat_id"==c[0])return unescape(c[1])}}})(sc);
$(function(){document.onclick=function(a){a.preventDefault()};app.menuView=new app.MenuView;app.menuView.setPic(!0);app.shoppingCart=new app.Order;app.vegetableCollection=new app.ItemCollection;app.meatCollection=new app.ItemCollection;app.soupCollection=new app.ItemCollection;app.specialityCollection=new app.ItemCollection;app.shoppingCartV=new app.ShoppingCartView({model:app.shoppingCart});$("#menu-container").append(app.shoppingCartV.render().el);$(".loader-mask").remove();app.menuView.renderList(1);
$("#menu-shadow").bind("click",function(){$("#menu-dropdown").hide();$("#menu-shadow").hide()});$("#todayList").bind("click",function(){window.location.reload()});$("#myOrder").bind("click",function(){$(".container").css("display","none");if("CUSTOMER"==user_status&&!sc.getWechatId()){$("#menu-shadow").click();$(".container").hide();var a=new app.LoginView({backTo:"menu-container"});$(".main-container").append(a.render().el)}else 0<$("#myOrders-container").length?$("#myOrders-container").show():app.myOrderView=
new app.MyOrdersView;$("#menu-shadow").click()});$("#logout").click(function(){if("CUSTOMER"==user_status&&!sc.getWechatId()){$("#menu-shadow").click();$(".container").hide();var a=new app.LoginView({backTo:"menu-container"});$(".main-container").append(a.render().el)}else setCookie("wechat_id","",-1),a=new app.OrderInfoPopupView({msg:"\u9000\u51fa\u767b\u5f55\u6210\u529f\uff01"}),$("#menu-dropdown").append(a.render().el),setTimeout(function(){$("#menu-shadow").click();$(".container").hide();var a=
new app.LoginView({backTo:"menu-container"});$(".main-container").append(a.render().el)},2E3)});$("#home-header").bind("touchmove",{},function(a){a.preventDefault()});$(".toolbar").bind("touchmove",{},function(a){a.preventDefault()});$(window).scrollTop(2)});